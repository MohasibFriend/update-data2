Object.defineProperty(window, "EXTENSION_SUBSCRIPTION", {
    value: {
        isSubscribed: true,
        isTrial: false,
        errorOccurred: false
    },
    writable: false,
    configurable: false
});

const customModalCSS = `

.modal-content {
  border-radius: 2.3rem !important;
  box-shadow: 0 12px 36px #3345771a, 0 1.5px 6px #3654d226;
  background: #f6f9ff;
  padding: 1.2rem 1rem !important;
  border: solid #40a9ff 3px;
  min-width: 330px;
  width: 100%;
  max-width: 100%;
  margin: auto;
}
.form-check {
    font-size: 1.06rem;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    justify-content: right;
    padding-left: 0px;
    background: #e9f0fc;
    font-weight: bold;
    padding:7px;
    border-radius: 7px;
   
}
.form-check-label {
    font-size: 1.06rem;
    color: #1a237e;
    font-weight: 600;
    flex: 1;
    width: auto;
    text-align: right;
    padding-right: 10px;
}
    .form-check-input {
    accent-color: #3452b6;
    width: 1.1em;
    height: 1.1em;
    margin: 0;
    flex-shrink: 0;
}  
`;
const styleTag = document.createElement('style');
styleTag.type = 'text/css';
styleTag.appendChild(document.createTextNode(customModalCSS));
document.head.appendChild(styleTag);



window.addEventListener("ReceiveExtensionData", e => {
    ! function (e) {
        try {
            const o = Object.freeze(e)
            Object.defineProperty(window, "EXTENSION_SUBSCRIPTION", {
                value: o,
                writable: !1,
                configurable: !1
            }), window.EtaProcessor && window.EtaProcessor.init()
        } catch (e) { }
    }(e.detail)
}, !1), 
window.dispatchEvent(new CustomEvent("RequestExtensionData"));
// ← هنا تستدعي الفانكشن
    (function () {
        const e = setInterval(async () => {
            if ("undefined" == typeof $ || !window.EtaProcessor) return
            clearInterval(e)
            const o = new Map,
                t = ["downloadExcelSummary", "downloadAllInvoices", "downloadExcelForReceipts", "downloadJsonForReceipts",
                    "downloadExcelForReceiptsNoDetails", "downloadAllPages", "downloadAllReceiptPages"
                ]
            function r(e, o) {
                return async function (...t) {
                    try {
                        return window.EXTENSION_SUBSCRIPTION.isSubscribed ? await o(...t) : void $(".subscriptionDiv")
                            .show()
                    } catch (o) {
                        console.error(`Error in protected method ${e}:`, o), $("#downloadModal").modal("hide"), $(
                            ".downloadAllBtn").removeClass("disabled")
                    }
                }
            }
            t.forEach(e => {
                window.EtaProcessor[e] && o.set(e, window.EtaProcessor[e].bind(window.EtaProcessor))
            })
            const i = new Proxy(window.EtaProcessor, {
                set: (e, o, r) => t.includes(o) ? (console.log(
                    `Security violation: Attempt to modify protected method ${o}`), !1) : (e[o] = r, !0),
                get: (e, i) => t.includes(i) && o.has(i) ? r(i, o.get(i)) : e[i],
                deleteProperty: (e, o) => t.includes(o) ? (console.log(
                    `Security violation: Attempt to delete protected method ${o}`), !1) : (delete e[o], !0)
            })
            Object.defineProperty(window, "EtaProcessor", {
                value: i,
                writable: !1,
                configurable: !1
            }), t.forEach(e => {
                if (o.has(e)) {
                    const t = r(e, o.get(e))
                    Object.defineProperty(window, e, {
                        value: t,
                        writable: !1,
                        configurable: !1
                    })
                }
            })
            const a = setInterval(() => {
                try {
                    if (!window.EtaProcessor || "Object" !== window.EtaProcessor.constructor.name) {
                        if (window.EtaProcessor && "object" == typeof window.EtaProcessor) return
                        console.log("Security violation: EtaProcessor replaced"), location.reload()
                    }
                    t.forEach(e => {
                        if (o.has(e)) {
                            const t = Object.getOwnPropertyDescriptor(window, e)
                                (!t || t.writable || t.configurable) && (console.log(
                                    `Security violation: Global function ${e} descriptor changed`), Object.defineProperty(
                                        window, e, {
                                        value: r(e, o.get(e)),
                                        writable: !1,
                                        configurable: !1
                                    }))
                        }
                    })
                } catch (e) { }
            }, 500)
            Object.defineProperty(window, "securityMonitor", {
                value: a,
                writable: !1,
                configurable: !1
            })
        }, 50)
    })();
var e = location.href,
    o = [],
    t = []
setInterval(function () {
    e !== location.href && (e = location.href, window.EtaProcessor && window.EtaProcessor.init())
}, 500), window.addEventListener("load", e => {
    const o = setInterval(async () => {
        null != $(".eta-layout-content").find("div[role='tablist']")[0] && (clearInterval(o), window
            .EtaProcessor && window.EtaProcessor.init())
    }, 50)
})
var r = window.XMLHttpRequest,
    i = ""
window.XMLHttpRequest = function () {
    var e = new r
    return e.addEventListener("readystatechange", function () {
        if (4 == e.readyState && 200 == e.status) {
            var r = "https://api-portal.invoicing.eta.gov.eg/api/v1/documents",
                a = "https://api-portal.invoicing.eta.gov.eg/api/v1/receipts"
            if (200 == e.status && (e.responseURL.match(`^${r}/recent`) || e.responseURL.match(`^${r}/search`)) && !
                window.EtaProcessor.isDownloading) {
                i = e.responseURL
                var s = JSON.parse(e.responseText)
                window.EtaProcessor.responseTotalCount = s.metadata.totalCount, o = s.result
            }
            200 != e.status || !e.responseURL.match(`^${a}/recent`) && !e.responseURL.match(`^${a}/search`) || window
                .EtaProcessor.isDownloading || (i = e.responseURL, s = JSON.parse(e.responseText), window.EtaProcessor
                    .responseTotalCount = s.metadata.totalCount, t = s.receipts), 200 == e.status && e.responseURL.match(
                        "^https://api-portal.invoicing.eta.gov.eg/api/v1/codetypes/codes/my") && (i = e.responseURL, s = JSON
                            .parse(e.responseText), window.EtaProcessor.responseTotalCount = s.metadata.totalCount, s.result)
        }
    }, !1), e
}, window.EtaProcessor = {
    language: "ar",
    responseTotalCount: 0,
    isDownloading: !1,
    isCancellationRequested: !1,
    init: function (e) {
        this.language = localStorage.i18nextLng || "ar", this.injectUI()
    },
    injectUI: function () {
        this.loadExtension()
    },
    toggleDownloadMode: function (e) {
        e ? ($("#downloadModal .modal-footer button").hide(), $("#modalCloseX").hide(), $("#progressContainer").show(),
            $("#inlineStopBtn").show()) : ($("#downloadModal .modal-footer button").show(), $("#modalCloseX").show(), $(
                "#progressContainer").hide())
    },
    finishDownload: function () {
        window.EtaProcessor.isDownloading = !1, window.EtaProcessor.isCancellationRequested = !1, window.EtaProcessor
            .toggleDownloadMode(!1), $(".downloadAllBtnText").html("Download All"), $(".downloadAllBtn").removeClass(
                "disabled")
    },
    fixCloseButtons: function () {
        $("#modalCloseX, #closeBtn").attr("data-dismiss", "modal"), $("#modalCloseX, #closeBtn").off("click").on(
            "click",
            function () {
                $("#downloadModal").modal("hide"), window.EtaProcessor.isCancellationRequested = !1, window.EtaProcessor
                    .isDownloading = !1, $(".downloadAllBtn").removeClass("disabled")
            })
    },
    createEnhancedModal: function () {
        var e = $('<div class="modal fade" id="downloadModal" data-backdrop="static" tabindex="-1"></div>'),
            o = $('<div class="modal-dialog" style="width:750px;max-width:95vw;"></div>'),
            t = $('<div class="modal-content" ></div>'),
            r = $(
                '<p style="font-size:16px;display:none;" class="subscriptionUrl"><a href="https://mohasibfriend.com" target="_blank">إضغط هنا لتفعيل الإشتراك</a></p>'
            ),
            i = $(

                '<p style="font-size:15px;direction:rtl;font-weight: bold;">Mohasib Friend<br>هذا العمل تابع لبرنامج محاسب فريند ويُدار بواسطة فريق التطوير الرسمي، لمزيد من المعلومات يرجى زيارة: <a href="https://mohasibfriend.com" target="_blank">mohasibfriend.com</a></p>'

            ),
            a = $('<h5 class="modal-title fs-5 bold text-center w-100"></h5>').append(r).append(i),
            s = $(
                '<button type="button" class="close" id="modalCloseX" aria-label="Close" style="position:absolute;right:15px;top:15px;font-size:20px;"><span aria-hidden="true">&times;</span></button>'
            ),
            n = $('<div class="modal-header pb-0" style="position:relative;"></div>').append(a).append(s),
            d = $('<div id="progressContainer" style="margin:15px;display:none;"></div>'),
            c = $(
                '<div class="progress" style="height:15px;border-radius:4px;background-color:#e0e0e0;overflow:hidden;"></div>'
            ),
            l = $(
                '<div id="progressBar" class="progress-bar" role="progressbar" style="height:100%;background-color:#2196F3;width:0%;transition:width 0.3s ease;text-align:center;color:white;font-size:12px;line-height:15px;"></div>'
            ),
            u = $('<div id="progressText" style="text-align:center;font-size:14px;margin-top:5px;color:#424242;"></div>'),
            p = $(
                '<button id="inlineStopBtn" type="button" style="display:block;margin:10px auto 0;padding:5px 15px;background-color:#dc3545;border:1px solid #dc3545;color:white;border-radius:4px;">Stop</button>'
            )
        c.append(l), d.append(c).append(u).append(p)
        var w = $('<div class="modal-body" style="padding:15px;"></div>'),
            h = $('<div style="display:flex;flex-wrap:wrap;margin:-7px;"></div>'),
            m = $('<div style="flex:0 0 50%;padding:7px;box-sizing:border-box; "></div>'),
            g = $('<div style="border:1.5px solid #000;border-radius:4px;overflow:hidden;"></div>'),
            y = $(
                '<div class="bg-primary pdfDownloadOptions" style="color:white;padding:10px;border-bottom:1px solid #ddd;font-weight:bold;text-align: right;"> PDF - خيارات إسم الملف</div>'
            ),
            b = $('<div style="padding:10px;" class="pdfDownloadOptions"></div>'),
            f = $('<div style="display:flex;flex-wrap:wrap;margin:-5px;"></div>'),
            v = $('<div style="flex:0 0 50%;padding:5px;box-sizing:border-box;"></div>'),
            P = $('<div style="flex:0 0 50%;padding:5px;box-sizing:border-box;"></div>')
        v.append($('<div class="form-check text-right"></div>').append($(
            '<input class="form-check-input" type="checkbox" id="option-seller-name">'), $(
                '<label class="form-check-label" for="option-seller-name">إسم البائع</label>')), $(
                    '<div class="form-check text-right"></div>').append($(
                        '<input class="form-check-input" type="checkbox" id="option-seller-id">'), $(
                            '<label class="form-check-label" for="option-seller-id">الرقم الضريبى للبائع</label>')), $(
                                '<div class="form-check text-right"></div>').append($(
                                    '<input class="form-check-input" type="checkbox" id="option-buyer-name">'), $(
                                        '<label class="form-check-label" for="option-buyer-name">إسم المشترى</label>')), $(
                                            '<div class="form-check text-right"></div>').append($(
                                                '<input class="form-check-input" type="checkbox" id="option-buyer-id">'), $(
                                                    '<label class="form-check-label" for="option-buyer-id">الرقم الضريبى للمشترى</label>')), $(
                                                        '<div class="form-check text-right"></div>').append($(
                                                            '<input class="form-check-input" type="checkbox" id="option-po-number">'), $(
                                                                '<label class="form-check-label" for="option-type">مرجع طلب الشراء</label>')), $(
                                                                    '<div class="form-check text-right"></div>').append($(
                                                                        '<input class="form-check-input" type="checkbox" id="option-so-number">'), $(
                                                                            '<label class="form-check-label" for="option-type">مرجع طلب البيع</label>'))), P.append($(
                                                                                '<div class="form-check text-right"></div>').append($(
                                                                                    '<input class="form-check-input" type="checkbox" checked id="option-id">'), $(
                                                                                        '<label class="form-check-label" for="option-id">الرقم الداخلى</label>')), $(
                                                                                            '<div class="form-check text-right"></div>').append($(
                                                                                                '<input class="form-check-input" type="checkbox" checked id="option-uuid">'), $(
                                                                                                    '<label class="form-check-label" for="option-uuid">الرقم الإلكترونى</label>')), $(
                                                                                                        '<div class="form-check text-right"></div>').append($(
                                                                                                            '<input class="form-check-input" type="checkbox" id="option-date">'), $(
                                                                                                                '<label class="form-check-label" for="option-date">تاريخ الفاتورة</label>')), $(
                                                                                                                    '<div class="form-check text-right"></div>').append($(
                                                                                                                        '<input class="form-check-input" type="checkbox" id="option-type">'), $(
                                                                                                                            '<label class="form-check-label" for="option-type">نوع المستند</label>')), $(
                                                                                                                                '<div class="form-check text-right"></div>').append($(
                                                                                                                                    '<input class="form-check-input" type="checkbox" id="option-separate-seller">'), $(
                                                                                                                                        '<label class="form-check-label" for="option-separate-seller">مجلد لكل بائع</label>')), $(
                                                                                                                                            '<div class="form-check text-right"></div>').append($(
                                                                                                                                                '<input class="form-check-input" type="checkbox" id="option-separate-buyer">'), $(
                                                                                                                                                    '<label class="form-check-label" for="option-separate-buyer">مجلد لكل مشترى</label>'))), g.append(y).append(
                                                                                                                                                        b), m.append(f), f.append(v).append(P), b.append(f), m.append(g)
        var k = $('<div style="flex:0 0 50%;margin-top:10px;box-sizing:border-box;"></div>'),
            E = $('<div style="border:1px solid #ddd;border-radius:4px;overflow:hidden;padding-bottom: 3px;"></div>'),
            x = $(
                '<div style="background-color:#f8f9fa;padding:10px;border-bottom:1px solid #ddd;font-weight:bold;text-align: right;color:#000;">خيارات التحميل</div>'
            ),
            A = $('<div style="padding:10px;"></div>'),
            D = $('<div class="form-check text-right"></div>'),
            T = $('<span id="modalTotalCountText"></span>'),
            C = $('<span id="docProfileText"></span>'),
            I = $('<input class="form-check-input" type="checkbox" checked id="option-download-all">'),
            B = $('<label class="form-check-label bold" for="option-download-all">تحميل جميع الصفحات - </label>').append(
                T).append(" ").append(C)
        D.append(I).append(B)
        var R = $('<div class="form-check text-right receiptDownloadOption"></div>').append($(
            '<input class="form-check-input" type="checkbox" id="option-download-details">'), $(
                '<label class="form-check-label bold" for="option-download-details">تحميل بيانات الإيصال - وقت تحميل أطول</label>'
            )),
            S = $('<div class="form-check text-right receiptDownloadOption"></div>').append($(
                '<input class="form-check-input" type="checkbox"  id="option-receipt-sort">'), $(
                    '<label class="form-check-label bold" style="color:red;" for="option-receipt-sort">حدد هذا الإختيار وإعادة المحاولة فى حالة فشل التحميل أكثر من 3000 إيصال</label>'
                ))
        A.append(D).append(R).append(S), E.append(x).append(A), k.append(E)
        var N = $('<div style="flex:0 0 50%;padding:7px;box-sizing:border-box; "class="excel-contenr"></div>'),
            O = $('<div style="border:1.5px solid #000;border-radius:4px;overflow:hidden;"></div>'),
            L = $(
                '<div class="bg-success" style="color:white;padding:10px;border-bottom:1px solid #ddd;font-weight:bold;text-align: right;">أعمدة ملف الإكسيل</div>'
            ),
            U = $('<div style="padding:10px;"></div>'),
            F = $('<div style="display:flex;flex-wrap:wrap;margin:-5px;"></div>'),
            M = $('<div style="flex:0 0 50%;padding:5px;box-sizing:border-box;"></div>'),
            J = $('<div style="flex:0 0 50%;padding:5px;box-sizing:border-box;"></div>')
        M.append($('<div class="form-check text-right"></div>').append($(
            '<input class="form-check-input column-option" type="checkbox" checked id="col-type">'), $(
                '<label class="form-check-label" for="col-type">نوع المستند</label>')), $(
                    '<div class="form-check text-right"></div>').append($(
                        '<input class="form-check-input column-option" type="checkbox" id="col-version">'), $(
                            '<label class="form-check-label" for="col-version">نسخة المستند</label>')), $(
                                '<div class="form-check text-right"></div>').append($(
                                    '<input class="form-check-input column-option" type="checkbox" checked id="col-status">'), $(
                                        '<label class="form-check-label" for="col-status">الحالة</label>')), $(
                                            '<div class="form-check text-right"></div>').append($(
                                                '<input class="form-check-input column-option" type="checkbox" checked id="col-dateIssued">'), $(
                                                    '<label class="form-check-label" for="col-dateIssued">تاريخ الإصدار</label>')), $(
                                                        '<div class="form-check text-right"></div>').append($(
                                                            '<input class="form-check-input column-option" type="checkbox" checked id="col-dateReceived">'), $(
                                                                '<label class="form-check-label" for="col-dateReceived">تاريخ الإستلام</label>')), $(
                                                                    '<div class="form-check text-right"></div>').append($(
                                                                        '<input class="form-check-input column-option" type="checkbox" checked id="col-issuerDetails">'), $(
                                                                            '<label class="form-check-label" for="col-issuerDetails">بيانات البائع</label>')), $(
                                                                                '<div class="form-check text-right"></div>').append($(
                                                                                    '<input class="form-check-input column-option" type="checkbox" checked id="col-buyerDetails">'), $(
                                                                                        '<label class="form-check-label" for="col-buyerDetails">بيانات المشترى</label>'))), J.append($(
                                                                                            '<div class="form-check text-right"></div>').append($(
                                                                                                '<input class="form-check-input column-option" type="checkbox" checked id="col-uuid">'), $(
                                                                                                    '<label class="form-check-label" for="col-uuid">الرقم الإلكترونى</label>')), $(
                                                                                                        '<div class="form-check text-right"></div>').append($(
                                                                                                            '<input class="form-check-input column-option" type="checkbox" id="col-signature">'), $(
                                                                                                                '<label class="form-check-label" for="col-signature">التوقيع الإلكترونى</label>')), $(
                                                                                                                    '<div class="form-check text-right"></div>').append($(
                                                                                                                        '<input class="form-check-input column-option" type="checkbox" id="col-url">'), $(
                                                                                                                            '<label class="form-check-label" for="col-url">الرابط الخارجى</label>')), $(
                                                                                                                                '<div class="form-check text-right"></div>').append($(
                                                                                                                                    '<input class="form-check-input column-option" type="checkbox" id="col-po">'), $(
                                                                                                                                        '<label class="form-check-label" for="col-po">مرجع طلب الشراء</label>')), $(
                                                                                                                                            '<div class="form-check text-right"></div>').append($(
                                                                                                                                                '<input class="form-check-input column-option" type="checkbox" id="col-so">'), $(
                                                                                                                                                    '<label class="form-check-label" for="col-so">مرجع طلب البيع</label>')), $(
                                                                                                                                                        '<div class="form-check text-right"></div>').append($(
                                                                                                                                                            '<input class="form-check-input column-option" type="checkbox" checked id="col-tax-columns">'), $(
                                                                                                                                                                '<label class="form-check-label" for="col-tax-columns">أعمدة الضريبة</label>')), $(
                                                                                                                                                                    '<div class="form-check text-right"></div>').append($(
                                                                                                                                                                        '<input class="form-check-input column-option" type="checkbox" checked id="col-discount-columns">'), $(
                                                                                                                                                                            '<label class="form-check-label" for="col-discount-columns">أعمدة الخصومات</label>')))
        var q = $("<div></div>")
        q.append($('<div class="form-check text-right"></div>').append($(
            '<input class="form-check-input" type="checkbox" checked id="option-combine-all">'), $(
                '<label class="form-check-label bold" for="option-combine-all">تجميع الأصناف فى صفحة واحدة</label>')), $(
                    '<div class="form-check text-right"></div>').append($(
                        '<input class="form-check-input" type="checkbox" checked id="option-negative-credit">'), $(
                            '<label class="form-check-label bold" for="option-negative-credit">تحويل مبلغ إشعار الخصم إلى رقم سالب</label>'
                        )), $('<div class="form-check text-right"></div>').append($(
                            '<input class="form-check-input" type="checkbox" id="option-valid-only">'), $(
                                '<label class="form-check-label bold" for="option-valid-only">تجاهل الفواتير المرفوضة والملغية (الغير صحيحة)</label>'
                            ))), F.append(J).append(M), U.append(F).append(q), O.append(L).append(U), N.append(O), m.append(k), h
                                .append(m).append(N), w.append(h).append(d)
        var j = $(
            '<div class="modal-footer subscriptionDiv" style="align-self:center;display:none;"><p style="font-size:16px;text-align:center;"><a style="color:red;" href="https://extension." target="_blank">إنتهت صلاحية الإشتراك<br/>إضغط هنا للتجديد</a></p></div>'
        ),
            Y = $(
                '<div class="modal-footer" style="display:flex;justify-content:space-between;padding:10px 15px;border-top:1px solid #ddd;"></div>'
            ),
            X = $("<div></div>"),
            z = $(
                '<button type="button" style="margin:0;padding:6px 12px;background-color:#dc3545;border:1px solid #dc3545;color:white;border-radius:4px;" id="closeBtn" class="btn btn-danger">Close</button>'
            )
        X.append(z)
        var G = $('<div style="display:flex;gap:5px;"></div>'),
            V = $(
                '<button type="button" style="margin:0;padding:6px 12px;background-color:#26d88b;border:1px solid #26d88b;color:white;border-radius:4px;display:flex;align-items:center;justify-content:center;gap:5px;" id="excelBtn" class="btn btn-success"><img src="data:image/png;base64,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" style="width:24px;height:24px;" alt="Excel icon" /><span>Excel</span></button>'
            ),
            H = $(
                '<button type="button" style="margin:0;padding:6px 12px;background-color:#3654d2;border:1px solid #3654d2;color:white;border-radius:4px;display:flex;align-items:center;justify-content:center;gap:5px;" id="submitDownloadInvoices" class="btn btn-primary"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAABZJJREFUaEPtmXtQVGUYxp+9nLN7dtmzF1wwWEWMBZOrCJlIM4U0TYPVjKClo5OmQ4CahYqmYF6TvBGZBZU5NY1/lOZYpjB4AVPBUBnFy4jIJZCAZRGwBXa5bHNOI4kLxh7gbM7w/Xu+y/N73+979t3vE+AJb4InXD9GABydwZEM/G8zUPCKF93d2b5PYEWMI0VaBTgoFEsXPXe8tKUvHf1uofMv6X50tPgHghmIsJzqWXYB5EfqrFwiL5DKQM5YgE7aGR2nDkFYcYPLNDZjpp6o7jPY/WaAK4AiJg6yyFnI//gDPBOzAE2p8aBEg/cK3gBU7+0ERnvg6KJXEbjwXVQd+AwTaXLQWeANQJm0B50Ujeylb0A1To+mitvwU5JQkcJBQfAHsCIN3SoXHI+L7hFMiQWYrJY8GQB0/CZQgdNwKHoaVJ7eaCovYYV7OonhTok5Q/CWAcXsJZBFzERWfDS0AaGoOPELK1okBELUEhBCbgeaNwAqPAr0vET8nr4RbsFhuPDJhp6oj6ZE8HIiOGWBNwBC5wVNciZaqsrQcPMqijJ39BI8SU1CLrb/QPMGwKjVpv0MISXH1f3puH30h14ASlIIf6X9tsorgHLROkhDI1CYvgl/nMm22TITaAKjJCK7thKvANT0aNCzElB35QLObkq0ESoR/WOr9pxnXgHotRmgxupZ4afXxKLx9nUbiLFyMcbKBm6rvAGQ3oFQJ+5Gm7EelLMLmu7cwsmkt20AmOiHaCQgB5gG3gDoZamgfEORvexNTN++D2JKjot7tqIy95gNhFYqgo9iYLbKCwAxRg/NugzUXi7Aua0roJ8xGwELl6PLYkFuchybjUdboIqEgvhvW+UFQJWwBZKAqchPXYOawt9YreEpaXANehbmv5pxOmkxTHU1vRjkYgEmDaBOGnYAYpwPNGs+R2tDLY6/828hJ5JSiEj9EvSY8TDV1yJ3bSza7xl7QegVBFylj7fVYQdQxm2ENCgcxd/tRcmRA70EMoc5fP1u0DpPFuLCrmTcK73Z04fZQaEa6WNtdVgBxO6ecE75mo1sVkIMu+cfbcxhDkv6CNqAEPZTWfZhCMUEpOpREEklIARgCz3GlKyNBlgKT8J8vbBnmmEFUC3ZDIl/GC5nbEd5zpFe2hU6D2h9J0PrHwwXv2CQCqUNXGPJNXR1dsBsbEBLTRX7nVKpoXjKHe2Z60F0dWDYAAjPCdCs3ot2Yx1+jZ0JUkHDxT8ErsFT4RoYim6LBS3V5WiuvIOWqgrcrypHW0M99K/Pgc/M+azYzjYTKvOycLcgD4biSz2AIlICNxdneJgbhw9AvepTkE/7sn9c2owG1mWaym6huaqsT9t8OPyURguPiCiMeT6SPR8PGmO3xpJi0O7jcG7bKvjKgJfzaob+VkISHgXVvES01tey24epfbg2uasbtP6ToR7vDZnWDaa6atzNz4XhehEYq024ZBg6ACJwGsoqKhG04QuIKRnOp67Gn4VnuWof0LhVVxoGD0B4TgT12kIUfpMOr9mL4Rb6fL8V54BU2dFpUABCuQKq2A/RJVPi1JaVcNZPxJSVW9hf15zl82BuarRDCreunAFEWjeol26DudWEnJRlIOROiNz1LUgnBVvvMHUPH40TgICUYtTG/ejssiIr8S10mO7jxW2Z0Hj7ofTYQVzZl8aHdnYNTgBMacCUCLnJ8TDevIopKzZDFxYBw40inElZypt4zgAinyBQc97Hte8z4Dc/AYzVlWUdRtFXO3kVzxmAGdg8JQq6GXNhqr2L0qyfUFOQy7t4TgAPHjjM3VZcbDTDyum1YGhYLd3WvHXFxhf6mq3fe76Hn5gqTB2obu0aGjV2zmIV4LTBIpi744ah1i4AO9dxWHduN60Ok2u78AiAo5MxkgFHZ+BvrBQsT5dhh+cAAAAASUVORK5CYII=" style="width:24px;height:24px;" alt="PDF icon" /><span>PDF</span></button>'
            ),
            K = $(
                '<button type="button" style="margin:0;padding:6px 12px;background-color:#6c757d;border:1px solid #6c757d;color:white;border-radius:4px;display:flex;align-items:center;justify-content:center;gap:5px;" id="jsonXmlBtn" class="btn btn-secondary"><img src="data:image/png;base64,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" style="width:24px;height:24px;" alt="JSON icon" /><span>JSON/XML</span></button>'
            )
        return G.append(K).append(H).append(V), Y.append(X).append(G), t.append(n).append(w).append(j).append(Y), o
            .append(t), e.append(o), $("#inlineStopBtn").on("click", function () {
                $("#inlineStopBtn").hide(), window.EtaProcessor.isCancellationRequested = !0, $("#progressText").text(
                    "Stopping Download, Please Wait...")
            }), e
    },
    initializeModalEvents: function () {
        $("#modalCloseX").on("click", function () {
            setTimeout(() => {
                window.EtaProcessor.finishDownload()
            }, 1500)
        }), $("#submitDownloadInvoices").on("click", function () {
            if (window.EtaProcessor.isDownloading) return
            const e = window.EtaProcessor.getEnhancedOptions()
            let t = window.EXTENSION_SUBSCRIPTION
            t && t.isSubscribed && (window.EtaProcessor.isDownloading = !0, window.EtaProcessor
                .isCancellationRequested = !1, window.EtaProcessor.toggleDownloadMode(!0), $("#progressContainer")
                    .show(), $("#progressBar").css("width", "0%"), $("#progressText").text("Starting Download Process...")
            ), e.downloadAll ? window.EtaProcessor.downloadAllPages().then(o => {
                window.EtaProcessor.downloadAllInvoices(o, !0, e)
            }) : window.EtaProcessor.downloadAllInvoices(o, !0, e)
        }), $("#jsonXmlBtn").on("click", function () {
            if (window.EtaProcessor.isDownloading) return
            const e = window.EtaProcessor.getEnhancedOptions()
            let r = window.EXTENSION_SUBSCRIPTION
            r && r.isSubscribed && (window.EtaProcessor.isDownloading = !0, window.EtaProcessor
                .isCancellationRequested = !1, window.EtaProcessor.toggleDownloadMode(!0), $("#progressContainer")
                    .show(), $("#progressBar").css("width", "0%"), $("#progressText").text("Starting Download Process...")
            ), "https://invoicing.eta.gov.eg/documents" === window.location.href ? e.downloadAll ? window
                .EtaProcessor.downloadAllPages().then(o => {
                    window.EtaProcessor.downloadAllInvoices(o, !1, e)
                }) : window.EtaProcessor.downloadAllInvoices(o, !1, e) : "https://invoicing.eta.gov.eg/receipts" ===
                window.location.href && (e.downloadAll ? window.EtaProcessor.downloadAllReceiptPages().then(o => {
                    window.EtaProcessor.downloadJsonForReceipts(o, e)
                }) : window.EtaProcessor.downloadJsonForReceipts(t, e))
        }), $("#excelBtn").on("click", function () {
            if (window.EtaProcessor.isDownloading) return
            const e = window.EtaProcessor.getEnhancedOptions()
            let r = window.EXTENSION_SUBSCRIPTION
            r && r.isSubscribed && (window.EtaProcessor.isDownloading = !0, window.EtaProcessor
                .isCancellationRequested = !1, window.EtaProcessor.toggleDownloadMode(!0), $("#progressContainer")
                    .show(), $("#progressBar").css("width", "0%"), $("#progressText").text("Starting Download Process...")
            ), "https://invoicing.eta.gov.eg/documents" === window.location.href ? e.downloadAll ? window
                .EtaProcessor.downloadAllPages().then(o => {
                    window.EtaProcessor.downloadExcelSummary(o, e)
                }) : window.EtaProcessor.downloadExcelSummary(o, e) : "https://invoicing.eta.gov.eg/receipts" === window
                    .location.href && (e.downloadAll ? window.EtaProcessor.downloadAllReceiptPages(e.receiptSort).then(
                        o => {
                            e.downloadDetails ? window.EtaProcessor.downloadExcelForReceipts(o, e) : window.EtaProcessor
                                .downloadExcelForReceiptsNoDetails(o, e)
                        }) : e.downloadDetails ? window.EtaProcessor.downloadExcelForReceipts(t, e) : window.EtaProcessor
                            .downloadExcelForReceiptsNoDetails(t, e))
        }), $("#closeBtn").on("click", function () {
            $(this).blur(), setTimeout(() => {
                window.EtaProcessor.finishDownload()
            }, 1500)
        }), $("#option-separate-seller").on("change", function () {
            $(this).is(":checked") && $("#option-separate-buyer").prop("checked", !1)
        }), $("#option-separate-buyer").on("change", function () {
            $(this).is(":checked") && $("#option-separate-seller").prop("checked", !1)
        }), $("input[type='checkbox']").on("change", function () {
            window.EtaProcessor.getEnhancedOptions()
        }), window.EtaProcessor.fixCloseButtons()
    },
    getEnhancedOptions: function () {
        const e = {
            date: $("#option-date").is(":checked"),
            id: $("#option-id").is(":checked"),
            seller_id: $("#option-seller-id").is(":checked"),
            seller_name: $("#option-seller-name").is(":checked"),
            buyer_id: $("#option-buyer-id").is(":checked"),
            buyer_name: $("#option-buyer-name").is(":checked"),
            type: $("#option-type").is(":checked"),
            uuid: $("#option-uuid").is(":checked"),
            salesOrderNumber: $("#option-so-number").is(":checked"),
            purchaseOrderNumber: $("#option-po-number").is(":checked"),
            separate_seller: $("#option-separate-seller").is(":checked"),
            separate_buyer: $("#option-separate-buyer").is(":checked"),
            downloadAll: $("#option-download-all").is(":checked"),
            combineAll: $("#option-combine-all").is(":checked"),
            negativeCredit: $("#option-negative-credit").is(":checked"),
            validOnly: $("#option-valid-only").is(":checked"),
            downloadDetails: $("#option-download-details").is(":checked"),
            receiptSort: $("#option-receipt-sort").is(":checked"),
            taxColumns: $("#col-tax-columns").is(":checked"),
            discountColumns: $("#col-discount-columns").is(":checked"),
            columns: {
                type: $("#col-type").is(":checked"),
                version: $("#col-version").is(":checked"),
                status: $("#col-status").is(":checked"),
                dateIssued: $("#col-dateIssued").is(":checked"),
                dateReceived: $("#col-dateReceived").is(":checked"),
                uuid: $("#col-uuid").is(":checked"),
                signature: $("#col-signature").is(":checked"),
                url: $("#col-url").is(":checked"),
                purchaseOrderReference: $("#col-po").is(":checked"),
                purchaseOrderDescription: $("#col-po").is(":checked"),
                salesOrderReference: $("#col-so").is(":checked"),
                salesOrderDescription: $("#col-so").is(":checked"),
                issuerId: $("#col-issuerDetails").is(":checked"),
                issuerName: $("#col-issuerDetails").is(":checked"),
                issuerAddress: $("#col-issuerDetails").is(":checked"),
                receiverId: $("#col-buyerDetails").is(":checked"),
                receiverName: $("#col-buyerDetails").is(":checked"),
                receiverMobileNumber: $("#col-buyerDetails").is(":checked"),
                receiverAddress: $("#col-buyerDetails").is(":checked")
            }
        }
        return e.separate_seller && e.separate_buyer && ($("#option-separate-buyer").prop("checked", !1), e
            .separate_buyer = !1), localStorage.setItem("extensionOptions", JSON.stringify(e)), e
    },
    loadEnhancedOptions: function () {
        const e = localStorage.getItem("extensionOptions")
        if (!e) return
        const o = JSON.parse(e)
             if (
  $("#option-date").prop("checked", o.date || false),
  $("#option-id").prop("checked", void 0 === o.id || o.id),
  $("#option-seller-id").prop("checked", o.seller_id || false),
  $("#option-seller-name").prop("checked", o.seller_name || false),
  $("#option-buyer-id").prop("checked", o.buyer_id || false),
  $("#option-buyer-name").prop("checked", o.buyer_name || false),
  $("#option-type").prop("checked", o.type || false),
  $("#option-uuid").prop("checked", void 0 === o.uuid || o.uuid),
  $("#option-so-number").prop("checked", void 0 !== o.salesOrderNumber && o.salesOrderNumber),
  $("#option-po-number").prop("checked", void 0 !== o.purchaseOrderNumber && o.purchaseOrderNumber),
  $("#option-separate-seller").prop("checked", o.separate_seller || false),
  $("#option-separate-buyer").prop("checked", o.separate_buyer || false),
  $("#option-download-all").prop("checked", o.downloadAll || false),
  $("#option-combine-all").prop("checked", o.combineAll || false),

  // these are now enabled by default
  $("#option-negative-credit").prop("checked", void 0 === o.negativeCredit || o.negativeCredit),
  $("#option-valid-only").prop("checked", void 0 === o.validOnly || o.validOnly),
  
  $("#option-download-details").prop("checked", o.downloadDetails || false),
  $("#option-receipt-sort").prop("checked", o.receiptSort || false),

  // default-enabled columns
  $("#col-tax-columns").prop("checked", void 0 === o.taxColumns || o.taxColumns),
  $("#col-discount-columns").prop("checked", o.discountColumns || false),
  $("#col-issuerDetails").prop("checked", void 0 === o.issuerDetails || o.issuerDetails),
  $("#col-buyerDetails").prop("checked", void 0 === o.buyerDetails || o.buyerDetails),
  $("#col-url").prop("checked", void 0 === o.url || o.url),

  o.columns
) {
  for (const e in o.columns) {
    const t = $(`#col-${e}`);
    t.length && t.prop("checked", o.columns[e]);
  }
}
    },

    updateProgressBar: function (e, o, t) {
        const r = $("#progressContainer"),
            i = $("#progressBar"),
            a = $("#progressText")
        if (!r.length || !i.length || !a.length) return
        r.show()
        let s = 0
        o > 0 && (s = Math.round(e / o * 100)), i.css("width", `${s}%`), i.text(`${s}%`), a.text(t ||
            `Processing ${e} / ${o}`)
        let n = "#43e97b",
            d = "#38f9d7",
            c = "0 2px 10px rgba(67, 233, 123, 0.4)"
        if (t && "string" == typeof t) {
            const e = t.toLowerCase()
            e.includes("preparing") || e.includes("ready") ? (n = "#4facfe", d = "#00f2fe", c =
                "0 2px 10px rgba(79, 172, 254, 0.4)") : e.includes("downloading") || e.includes("downloaded") ? (n =
                    "#43e97b", d = "#38f9d7", c = "0 2px 10px rgba(67, 233, 123, 0.4)") : e.includes("processing") || e
                        .includes("generating") ? (n = "#fa709a", d = "#fee140", c = "0 2px 10px rgba(250, 112, 154, 0.4)") : e
                            .includes("saving") || e.includes("finalizing") || e.includes("initializing") ? (n = "#667eea", d =
                                "#764ba2", c = "0 2px 10px rgba(102, 126, 234, 0.4)") : e.includes("completed") || e.includes("success") ?
                (n = "#56ab2f", d = "#a8e6cf", c = "0 2px 10px rgba(86, 171, 47, 0.4)") : e.includes("error") || e.includes(
                    "failed") ? (n = "#ff6b6b", d = "#ffa500", c = "0 2px 10px rgba(255, 107, 107, 0.4)") : e.includes(
                        "cancel") && (n = "#757575", d = "#9e9e9e", c = "0 2px 10px rgba(117, 117, 117, 0.4)")
        }
        i.css({
            background: `linear-gradient(45deg, ${n} 0%, ${d} 100%)`,
            "box-shadow": c,
            transition: "all 0.3s ease-in-out"
        }), s < 100 && !t?.toLowerCase().includes("error") && !t?.toLowerCase().includes("completed") ? (i.addClass(
            "progress-pulse"), i.removeClass("progress-no-animation")) : (i.removeClass("progress-pulse"), i.addClass(
                "progress-no-animation")), (e >= o || 0 === o) && !window.EtaProcessor.isDownloading && setTimeout(() => {
                    0 === o && (i.css("width", "100%"), i.css("background",
                        "linear-gradient(45deg, #F44336 0%, #ff6b6b 100%)")), window.EtaProcessor.isDownloading || r.hide()
                }, 2e3)
    },
    loadExtension: function () {
        const e = setInterval(() => {
            let o = window.EXTENSION_SUBSCRIPTION
            
            if (void 0 !== o && (clearInterval(e), !o.errorOccurred && !$(".downloadAllBtn").length)) {
                var t = window.EtaProcessor.createEnhancedModal()
                $("#downloadModal").length || ($("body").append(t), window.EtaProcessor.initializeModalEvents())
                try {
                    var r = $(".eta-layout-content").find("div[role='tablist']")[0]
                    if ("https://invoicing.eta.gov.eg/documents" === location.href) {
                        var i = $(
                            '<button type="button" class="ms-Button ms-Pivot-link downloadAllBtn">\n            <span><span><span class="ms-Pivot-icon"><i data-icon-name="Documentation" aria-hidden="true" class="root-66"></i></span>\n            <span class="downloadAllBtnText">Download All</span>\n            </span></span></button>'
                        )
                        $(r).append(i), $(i).click(() => {
                            if ($(i).hasClass("disabled")) return !1
                            $("#downloadModal").modal("show"), $("#modalTotalCountText").text(window.EtaProcessor
                                .responseTotalCount), $("#docProfileText").text("فاتورة"), $("#submitDownloadInvoices")
                                    .show(), $(".pdfDownloadOptions").show(), $(".receiptDownloadOption").hide(), window
                                        .EtaProcessor.loadEnhancedOptions()
                            let e = window.EXTENSION_SUBSCRIPTION
                            e.isSubscribed && !e.isTrial || $(".subscriptionUrl").show()
                        })
                    } else "https://invoicing.eta.gov.eg/receipts" === location.href ? (r = $(".subPivot[role='toolbar']")
                        .find("div[role='tablist']")[0], i = $(
                            '<button type="button" class="ms-Button ms-Pivot-link downloadAllBtn">\n            <span><span><span class="ms-Pivot-icon"><i data-icon-name="Documentation" aria-hidden="true" class="root-66"></i></span>\n            <span class="downloadAllBtnText">Download All</span>\n            </span></span></button>'
                        ), $(r).append(i), $(i).click(() => {
                            if ($(i).hasClass("disabled")) return !1
                            $("#downloadModal").modal("show"), $("#modalTotalCountText").text(window.EtaProcessor
                                .responseTotalCount), $("#docProfileText").text("إيصال"), $("#submitDownloadInvoices")
                                    .hide(), $(".pdfDownloadOptions").hide(), $(".receiptDownloadOption").show(), window
                                        .EtaProcessor.loadEnhancedOptions()
                            let e = window.EXTENSION_SUBSCRIPTION
                            e.isSubscribed && !e.isTrial || $(".subscriptionUrl").show()
                        })) : "https://invoicing.eta.gov.eg/codeusages" === location.href && (i = $(
                            '<button type="button" class="ms-Button ms-Pivot-link downloadAllBtn" style="background-color: transparent;">\n            <span><span><span class="ms-Pivot-icon"></span>\n            <span class="downloadAllBtnText">Download All</span>\n            </span></span></button>'
                        ), $(r).append(i), $(i).click(() => {
                            if ($(i).hasClass("disabled")) return !1
                            window.EtaProcessor.downloadAllCodes().then(e => {
                                if (e.length > 0) {
                                    $(i).addClass("disabled")
                                    const n = new ExcelJS.Workbook,
                                        d = n.addWorksheet("الأكواد")
                                    d.views = [{
                                        rightToLeft: !0,
                                        rtl: !0,
                                        activeCell: "A1"
                                    }]
                                    var o = [{
                                        header: "نوع الكود",
                                        key: "codeTypeNamePrimaryLang",
                                        width: 10
                                    }, {
                                        header: "رقم مميز",
                                        key: "codeLookupValue",
                                        width: 17
                                    }, {
                                        header: "اسم الكود",
                                        key: "codeNameSecondaryLang",
                                        width: 30
                                    }, {
                                        header: "اسم الكود بالانجليزية",
                                        key: "codeNamePrimaryLang",
                                        width: 30
                                    }, {
                                        header: "نشط",
                                        key: "active",
                                        width: 8
                                    }, {
                                        header: "نشط من",
                                        key: "activeFrom",
                                        width: 12
                                    }, {
                                        header: "نشط إلى",
                                        key: "activeTo",
                                        width: 12
                                    }]
                                    d.columns = o
                                    var t = []
                                    for (var r in e) {
                                        var a = e[r],
                                            s = {
                                                codeTypeNamePrimaryLang: a.codeTypeNamePrimaryLang,
                                                codeLookupValue: a.codeLookupValue,
                                                codeNameSecondaryLang: a.codeNameSecondaryLang,
                                                codeNamePrimaryLang: a.codeNamePrimaryLang,
                                                active: a.active ? "نعم" : "لا",
                                                activeFrom: new Date(a.activeFrom),
                                                activeTo: null == a.activeTo ? "" : new Date(a.activeTo)
                                            }
                                        t.push(s)
                                    }
                                    d.addRows(t), d.autoFilter = {
                                        from: "A1",
                                        to: {
                                            row: t.length + 1,
                                            column: o.length
                                        }
                                    }, n.xlsx.writeBuffer().then(function (e) {
                                        var o = new Blob([e], {
                                            type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                                        })
                                        saveAs(o, "Codes.xlsx"), $(".downloadAllBtnText").html("Download All"), $(i)
                                            .removeClass("disabled"), window.EtaProcessor.isDownloading = !1
                                    })
                                }
                            })
                        }))
                } catch (e) {
                    console.log(e)
                }
            }
        }, 50)
    },
    downloadExcelSummary: async function (e, o) {
        try {
            let k = window.EXTENSION_SUBSCRIPTION
            if (void 0 === k) return void console.log("Subscription is not defined.")
            if (!k.isSubscribed) return !1
            var t = e.length
            if (t > 0) {
                var r = $(".downloadAllBtn")
                $(r).addClass("disabled")
                const batchConfig = {
                    size: 200,
                    maxConcurrent: 50,
                    retryLimit: 10,
                    retryDelay: 500,
                    progressInterval: 1
                };
                let retryList = [];     // قائمة UUID المحجوزة لإعادة المحاولة

                // ﹏﹏﹏﹏﹏﹏﹏ بداية التحميل ﹏﹏﹏﹏﹏﹏﹏
                var i = [];             // مصفوفة النتائج (مثل الأصل)
                let x = 0;              // عدّاد المحاولات

                window.EtaProcessor.updateProgressBar(0, t, "Preparing Download Operation...");

                for (let start = 0; start < e.length && !window.EtaProcessor.isCancellationRequested; start += batchConfig.size) {
                    const batch = e.slice(start, start + batchConfig.size);

                    for (let off = 0; off < batch.length; off += batchConfig.maxConcurrent) {
                        const chunk = batch.slice(off, off + batchConfig.maxConcurrent);
                        const promises = chunk.map(item => {
                            const src = item.source || item;
                            return (async () => {
                                try {
                                    const detail = await window.EtaProcessor.getDocumentDetails(src.uuid);
                                    x++;
                                    if (x % batchConfig.progressInterval === 0 || x === t) {
                                        window.EtaProcessor.updateProgressBar(x, t, `Downloading ${x}/${t}`);
                                    }
                                    i.push(detail);
                                    return;
                                } catch {
                                    x++;
                                    retryList.push({ uuid: src.uuid, tries: 0 });
                                    if (x % batchConfig.progressInterval === 0) {
                                        window.EtaProcessor.updateProgressBar(
                                            x, t,
                                            `Downloading ${x}/${t} (Success: ${i.length}, Queued: ${retryList.length})`
                                        );
                                    }
                                }
                            })();
                        });

                        await Promise.all(promises);
                        if (window.EtaProcessor.isCancellationRequested) break;
                    }
                    if (window.EtaProcessor.isCancellationRequested) break;
                }

                // ﹏﹏﹏﹏﹏﹏﹏ إعادة المحاولة ﹏﹏﹏﹏﹏﹏﹏
                if (retryList.length && !window.EtaProcessor.isCancellationRequested) {
                    window.EtaProcessor.updateProgressBar(x, t, `Retrying ${retryList.length} failed...`);
                    const retryBatchSize = Math.min(10, Math.ceil(retryList.length / 5));

                    while (retryList.length && !window.EtaProcessor.isCancellationRequested) {
                        const slice = retryList.splice(0, retryBatchSize).map(entry => (async () => {
                            await new Promise(r => setTimeout(r, batchConfig.retryDelay * (entry.tries + 1)));
                            try {
                                const detail = await window.EtaProcessor.getDocumentDetails(entry.uuid);
                                i.push(detail);
                            } catch {
                                entry.tries++;
                                if (entry.tries < batchConfig.retryLimit) retryList.push(entry);
                            } finally {
                                window.EtaProcessor.updateProgressBar(x, t, `Retrying... Remaining: ${retryList.length}`);
                            }
                        })());

                        await Promise.all(slice);
                        await new Promise(r => setTimeout(r, batchConfig.retryDelay));
                    }
                } window.EtaProcessor.updateProgressBar(t, t, "Preparing Excel Sheet…");
                const A = new ExcelJS.Workbook,
                    D = A.addWorksheet("جميع الفواتير")
                D.views = [{
                    rightToLeft: !0,
                    rtl: !0,
                    activeCell: "A1",
                    state: "frozen",
                    ySplit: 1
                }]
                const T = o?.columns || {}
                var a, s = [{
                    header: "مسلسل",
                    key: "index",
                    width: 10
                }, {
                    header: "تفاصيل",
                    key: "details",
                    width: 10,
                    style: {
                        font: {
                            name: "Comic Sans MS",
                            family: 4,
                            size: 12,
                            underline: !0,
                            bold: !0
                        }
                    }
                }, {
                    header: "نوع المستند",
                    key: "type",
                    width: 12
                }, {
                    header: "نسخة المستند",
                    key: "version",
                    width: 13
                }, {
                    header: "الحالة",
                    key: "status",
                    width: 10
                }, {
                    header: "تاريخ الإصدار",
                    key: "dateIssued",
                    width: 13
                }, {
                    header: "تاريخ التقديم",
                    key: "dateReceived",
                    width: 13
                }, {
                    header: "عملة الفاتورة",
                    key: "currency",
                    width: 13
                }, {
                    header: "قيمة الفاتورة",
                    key: "netAmount",
                    width: 12
                }, {
                    header: "إجمالى الفاتورة",
                    key: "totalAmount",
                    width: 14
                }, {
                    header: "الرقم الداخلى",
                    key: "invoiceNumber",
                    width: 23
                }, {
                    header: "الرقم الإلكترونى",
                    key: "uuid",
                    width: 32
                }, {
                    header: "الرقم الضريبى للبائع",
                    key: "issuerId",
                    width: 17
                }, {
                    header: "إسم البائع",
                    key: "issuerName",
                    width: 32
                }, {
                    header: "عنوان البائع",
                    key: "issuerAddress",
                    width: 32
                }, {
                    header: "الرقم الضريبى للمشترى",
                    key: "receiverId",
                    width: 17
                }, {
                    header: "إسم المشترى",
                    key: "receiverName",
                    width: 32
                }, {
                    header: "عنوان المشترى",
                    key: "receiverAddress",
                    width: 32
                }, {
                    header: "مرجع طلب الشراء",
                    key: "purchaseOrderReference",
                    width: 32
                }, {
                    header: "وصف طلب الشراء",
                    key: "purchaseOrderDescription",
                    width: 32
                }, {
                    header: "مرجع طلب المبيعات",
                    key: "salesOrderReference",
                    width: 32
                }, {
                    header: "وصف طلب المبيعات",
                    key: "salesOrderDescription",
                    width: 32
                }, {
                    header: "التوقيع الإلكترونى",
                    key: "signature",
                    width: 32
                }, {
                    header: "الرابط الخارجى",
                    key: "url",
                    width: 120
                }].filter(e => "index" === e.key || "details" === e.key || !1 !== T[e.key]),
                    n = [],
                    d = [],
                    c = [],
                    l = [],
                    u = k.isTrial ? 2 : 1,
                    p = k.isTrial ? 2 : 1
                k.isTrial && n.push({
                    index: {
                        text: "تجربة مجانية لمدة 3 أيام، لتفعيل الإشتراك يرجى زيارة https://extension.",
                        hyperlink: "https://extension."
                    }
                }), baseDetColumns = [{
                    header: "كود الصنف",
                    key: "itemCode",
                    width: 14
                }, {
                    header: "إسم الكود",
                    key: "itemSecondaryName",
                    width: 14
                }, {
                    header: "الوصف",
                    key: "description",
                    width: 25
                }, {
                    header: "الكمية",
                    key: "quantity",
                    width: 10
                }, {
                    header: "كود الوحدة",
                    key: "unitType",
                    width: 12
                }, {
                    header: "إسم الوحدة",
                    key: "unitTypeName",
                    width: 20
                }, {
                    header: "السعر",
                    key: "unitValue",
                    width: 10
                }, {
                    header: "القيمة",
                    key: "netTotal",
                    width: 10
                }, {
                    header: "الإجمالى",
                    key: "total",
                    width: 10,
                    totalsRowFunction: "sum"
                }], o?.combineAll && (baseDetColumns = [{
                    header: "نوع المستند",
                    key: "type",
                    width: 12
                }, {
                    header: "نسخة المستند",
                    key: "version",
                    width: 13
                }, {
                    header: "الحالة",
                    key: "status",
                    width: 10
                }, {
                    header: "رقم الفاتورة",
                    key: "invoiceNumber",
                    width: 23
                }, {
                    header: "تاريخ الإصدار",
                    key: "dateIssued",
                    width: 13
                }, {
                    header: "تاريخ التقديم",
                    key: "dateReceived",
                    width: 13
                }, {
                    header: "كود الصنف",
                    key: "itemCode",
                    width: 14
                }, {
                    header: "إسم الكود",
                    key: "itemSecondaryName",
                    width: 14
                }, {
                    header: "الوصف",
                    key: "description",
                    width: 25
                }, {
                    header: "الكمية",
                    key: "quantity",
                    width: 10
                }, {
                    header: "كود الوحدة",
                    key: "unitType",
                    width: 12
                }, {
                    header: "إسم الوحدة",
                    key: "unitTypeName",
                    width: 20
                }, {
                    header: "السعر",
                    key: "unitValue",
                    width: 10
                }, {
                    header: "القيمة",
                    key: "netTotal",
                    width: 10
                }, {
                    header: "الإجمالى",
                    key: "total",
                    width: 10
                }, {
                    header: "الرقم الضريبى للبائع",
                    key: "issuerId",
                    width: 17
                }, {
                    header: "إسم البائع",
                    key: "issuerName",
                    width: 32
                }, {
                    header: "عنوان البائع",
                    key: "issuerAddress",
                    width: 32
                }, {
                    header: "الرقم الضريبى للمشترى",
                    key: "receiverId",
                    width: 17
                }, {
                    header: "إسم المشترى",
                    key: "receiverName",
                    width: 32
                }, {
                    header: "عنوان المشترى",
                    key: "receiverAddress",
                    width: 32
                }, {
                    header: "مرجع طلب الشراء",
                    key: "purchaseOrderReference",
                    width: 32
                }, {
                    header: "وصف طلب الشراء",
                    key: "purchaseOrderDescription",
                    width: 32
                }, {
                    header: "مرجع طلب المبيعات",
                    key: "salesOrderReference",
                    width: 32
                }, {
                    header: "وصف طلب المبيعات",
                    key: "salesOrderDescription",
                    width: 32
                }, {
                    header: "الرقم الإلكترونى",
                    key: "uuid",
                    width: 32
                }, {
                    header: "التوقيع الإلكترونى",
                    key: "signature",
                    width: 32
                }], a = A.addWorksheet("بيانات الفواتير")), d = baseDetColumns.filter(e => "index" === e.key ||
                    "details" === e.key || !1 !== T[e.key]), window.EtaProcessor.updateProgressBar(t, t,
                        "Processing Invoice Details...")
                const C = o.validOnly ? i.filter(e => {
                    if (!e) return !1
                    let o = e.status
                    return "Valid" === e.status && null != e.cancelRequestDate && null == e.declineCancelRequestDate && (
                        o = "Cancellation Requested"), "Valid" === e.status && null != e.rejectRequestDate && null == e
                            .declineRejectRequestDate && (o = "Rejection Requested"), "Valid" === o
                }) : i
                let I = 0
                for (const e of C)
                    if (I++, window.EtaProcessor.updateProgressBar(I, C.length, `Processing ${I}/${C.length}`), void 0 !==
                        e) {
                        var w = e.currenciesSold
                        "EGP" !== w && (w = e.invoiceLines[0].unitValue.currencySold)
                        var h = e.issuer.address ?? [],
                            m = e.receiver.address ?? [],
                            g = e.status
                        "Valid" === e.status && null != e.cancelRequestDate && null == e.declineCancelRequestDate && (g =
                            "Cancellation Requested"), "Valid" === e.status && null != e.rejectRequestDate && null == e
                                .declineRejectRequestDate && (g = "Rejection Requested")
                        var y = o.negativeCredit && "Credit Note" === e.documentTypeNamePrimaryLang,
                            b = {
                                index: I,
                                type: e.documentTypeNameSecondaryLang,
                                version: e.documentTypeVersion,
                                status: g,
                                dateIssued: window.EtaProcessor.toUserLocalTime(e.dateTimeIssued),
                                dateReceived: window.EtaProcessor.toUserLocalTime(e.dateTimeRecevied),
                                currency: w,
                                invoiceNumber: e.internalID,
                                netAmount: y ? -1 * e.netAmount : e.netAmount,
                                totalAmount: y ? -1 * e.totalAmount : e.totalAmount,
                                uuid: e.uuid,
                                issuerId: e.issuer.id,
                                issuerName: e.issuer.name,
                                issuerAddress: `${h.buildingNumber} ${h.street} ${h.regionCity} ${h.governate}`,
                                receiverId: e.receiver.id,
                                receiverName: e.receiver.name,
                                receiverAddress: `${m.buildingNumber} ${m.street} ${m.regionCity} ${m.governate}`,
                                purchaseOrderReference: e.purchaseOrderReference,
                                purchaseOrderDescription: e.purchaseOrderDescription,
                                salesOrderReference: e.salesOrderReference,
                                salesOrderDescription: e.salesOrderDescription,
                                signature: e.signatures[0] && e.signatures[0].signedBy ? e.signatures[0].signedBy : "",
                                url: {
                                    text: e.publicUrl,
                                    hyperlink: e.publicUrl
                                }
                            }
                        o?.taxColumns && $.each(e.taxTotals, (e, o) => {
                            if (-1 == window.EtaProcessor.getColumnIndex(s, o.taxType)) {
                                var t = window.EtaProcessor.getTaxTypeDescription(o.taxType)
                                s.splice(window.EtaProcessor.getColumnIndex(s, "totalAmount") + 1, 0, {
                                    header: t.description,
                                    key: o.taxType,
                                    width: t.width
                                })
                            }
                            b[o.taxType] = y ? -1 * o.amount : o.amount
                        }), "EGP" !== w && (-1 == window.EtaProcessor.getColumnIndex(s, "currencyExchangeRate") && s.splice(
                            window.EtaProcessor.getColumnIndex(s, "netAmount"), 0, {
                            header: "سعر العملة",
                            key: "currencyExchangeRate",
                            width: 13
                        }), -1 == window.EtaProcessor.getColumnIndex(s, "currencyTotal") && s.splice(window.EtaProcessor
                            .getColumnIndex(s, "netAmount"), 0, {
                            header: "مبلغ العملة",
                            key: "currencyTotal",
                            width: 13
                        }), b.currencyExchangeRate = e.currencySegments[0].currencyExchangeRate, b.currencyTotal = y ? -
                            1 * e.currencySegments[0].totalAmount : e.currencySegments[0].totalAmount), o?.discountColumns && (e
                                .totalItemsDiscountAmount && e.totalItemsDiscountAmount > 0 && (-1 == window.EtaProcessor
                                    .getColumnIndex(s, "itemsDiscount") && s.splice(window.EtaProcessor.getColumnIndex(s,
                                        "totalAmount") + 1, 0, {
                                        header: "خصم الأصناف",
                                        key: "itemsDiscount",
                                        width: 13
                                    }), b.itemsDiscount = y ? -1 * e.totalItemsDiscountAmount : e.totalItemsDiscountAmount), e
                                        .totalDiscount && e.totalDiscount > 0 && (-1 == window.EtaProcessor.getColumnIndex(s, "discount") &&
                                            s.splice(window.EtaProcessor.getColumnIndex(s, "totalAmount") + 1, 0, {
                                                header: "خصم الفاتورة",
                                                key: "discount",
                                                width: 13
                                            }), b.discount = y ? -1 * e.totalDiscount : e.totalDiscount), e.extraDiscountAmount && e
                                                .extraDiscountAmount > 0 && (-1 == window.EtaProcessor.getColumnIndex(s, "extraDiscount") && s
                                                    .splice(window.EtaProcessor.getColumnIndex(s, "totalAmount") + 1, 0, {
                                                        header: "خصم إضافى",
                                                        key: "extraDiscount",
                                                        width: 13
                                                    }), b.extraDiscount = y ? -1 * e.extraDiscountAmount : e.extraDiscountAmount)), e.payment && e
                                                        .payment.bankAccountIBAN && (-1 == window.EtaProcessor.getColumnIndex(s, "bankAccountIBAN") && s
                                                            .splice(window.EtaProcessor.getColumnIndex(s, "url"), 0, {
                                                                header: "IBAN",
                                                                key: "bankAccountIBAN",
                                                                width: 13
                                                            }), b.bankAccountIBAN = e.payment.bankAccountIBAN)
                        var f = I
                        o?.combineAll || (c = [], a = A.addWorksheet(`${f}`)), a.views = [{
                            rightToLeft: !0,
                            rtl: !0,
                            activeCell: "A1",
                            state: "frozen",
                            ySplit: 1
                        }], "EGP" !== w && -1 == window.EtaProcessor.getColumnIndex(d, "currencySold") && (d.splice(window
                            .EtaProcessor.getColumnIndex(d, "issuerId") || d.length, 0, {
                            header: "العملة",
                            key: "currencySold",
                            width: 10
                        }), d.splice(window.EtaProcessor.getColumnIndex(d, "issuerId") || d.length, 0, {
                            header: "سعر العملة",
                            key: "currencyExchangeRate",
                            width: 12
                        }), d.splice(window.EtaProcessor.getColumnIndex(d, "issuerId") || d.length, 0, {
                            header: "القيمة",
                            key: "amountSold",
                            width: 10
                        }), d.splice(window.EtaProcessor.getColumnIndex(d, "issuerId") || d.length, 0, {
                            header: "الإجمالى",
                            key: "totalForeign",
                            width: 10
                        })), p = u + 1, l.push(p)
                        for (const t of e.invoiceLines) {
                            u += 1
                            var v = {
                                type: e.documentTypeNameSecondaryLang,
                                version: e.documentTypeVersion,
                                status: g,
                                invoiceNumber: e.internalID,
                                dateIssued: window.EtaProcessor.toUserLocalTime(e.dateTimeIssued),
                                dateReceived: window.EtaProcessor.toUserLocalTime(e.dateTimeRecevied),
                                itemCode: t.itemCode,
                                itemSecondaryName: t.itemSecondaryName,
                                description: t.description,
                                quantity: t.quantity,
                                unitType: t.unitType,
                                unitTypeName: t.unitTypePrimaryName,
                                unitValue: y ? -1 * t.unitValue.amountEGP : t.unitValue.amountEGP,
                                netTotal: y ? -1 * t.netTotal : t.netTotal,
                                total: y ? -1 * t.total : t.total,
                                issuerId: e.issuer.id,
                                issuerName: e.issuer.name,
                                issuerAddress: `${h.buildingNumber} ${h.street} ${h.regionCity} ${h.governate}`,
                                receiverId: e.receiver.id,
                                receiverName: e.receiver.name,
                                receiverAddress: `${m.buildingNumber} ${m.street} ${m.regionCity} ${m.governate}`,
                                purchaseOrderReference: e.purchaseOrderReference,
                                purchaseOrderDescription: e.purchaseOrderDescription,
                                salesOrderReference: e.salesOrderReference,
                                salesOrderDescription: e.salesOrderDescription,
                                uuid: e.uuid,
                                signature: e.signatures[0] && e.signatures[0].signedBy ? e.signatures[0].signedBy : ""
                            }
                            if (o?.taxColumns && $.each(t.lineTaxableItems, (e, o) => {
                                if (-1 == window.EtaProcessor.getColumnIndex(d, o.taxType)) {
                                    var t = window.EtaProcessor.getTaxTypeDescription(o.taxType)
                                    d.splice(window.EtaProcessor.getColumnIndex(d, "total") + 1, 0, {
                                        header: t.description,
                                        key: o.taxType,
                                        width: t.width
                                    })
                                }
                                v[o.taxType] = o.amount
                            }), o?.discountColumns && (t.valueDifference && t.valueDifference > 0 && (-1 == window.EtaProcessor
                                .getColumnIndex(d, "valueDifference") && d.splice(window.EtaProcessor.getColumnIndex(d,
                                    "total") + 1, 0, {
                                    header: "فرق قيمة لأغراض الضريبة",
                                    key: "valueDifference",
                                    width: 20
                                }), v.valueDifference = t.valueDifference), t.discount && t.discount.amount && t.discount
                                    .amount > 0 && (-1 == window.EtaProcessor.getColumnIndex(d, "discount") && d.splice(window
                                        .EtaProcessor.getColumnIndex(d, "total") + 1, 0, {
                                        header: "خصم",
                                        key: "discount",
                                        width: 10
                                    }), v.discount = t.discount.amount), t.itemsDiscount && t.itemsDiscount > 0 && (-1 == window
                                        .EtaProcessor.getColumnIndex(d, "discount") && d.splice(window.EtaProcessor.getColumnIndex(d,
                                            "total") + 1, 0, {
                                            header: "خصم",
                                            key: "discount",
                                            width: 10
                                        }), v.discount = t.itemsDiscount)), "EGP" !== w && (v.currencySold = t.unitValue.currencySold, v
                                            .currencyExchangeRate = t.unitValue.currencyExchangeRate, v.amountSold = t.unitValue.amountSold, v
                                                .totalForeign = t.totalForeign), c.push(v), t === e.invoiceLines[e.invoiceLines.length - 1] && !o
                                                    ?.combineAll) {
                                a.columns = d, a.addRows(c)
                                var P = k.isTrial ? f + 2 : f + 1
                                a.addRow({
                                    itemCode: {
                                        text: "عودة",
                                        hyperlink: `#'جميع الفواتير'!B${P}`
                                    }
                                }), a.getCell(`A${e.invoiceLines.length + 2}`).font = {
                                    name: "Calibri",
                                    size: 14,
                                    underline: !0,
                                    bold: !0
                                }
                            }
                        }
                        b.details = o?.combineAll ? {
                            text: "عرض",
                            hyperlink: `#'بيانات الفواتير'!A${k.isTrial ? p - 1 : p}`
                        } : {
                            text: "عرض",
                            hyperlink: `#'${f}'!A1`
                        }, n.push(b)
                    } window.EtaProcessor.updateProgressBar(I, C.length, "Saving Excel File..."), D.columns = s, D.addRows(n),
                        k.isTrial && (D.mergeCells("A2:L2"), D.getCell("A2").font = {
                            name: "Calibri",
                            size: 19,
                            underline: !1,
                            bold: !0,
                            color: {
                                argb: "FF8B0000"
                            }
                        }), o?.combineAll && (a.columns = d, a.addRows(c), $.each(l, (e, o) => {
                            a.getCell(`A${o}`).font = {
                                name: "Calibri",
                                size: 11,
                                underline: !0,
                                bold: !0
                            }
                        })), D.getCell("B1").font = {
                            name: "Calibri",
                            size: 11,
                            underline: !1,
                            bold: !1
                        }, D.autoFilter = {
                            from: "A1",
                            to: {
                                row: n.length + 1,
                                column: s.length - 1
                            }
                        }, o?.combineAll && a && (a.autoFilter = {
                            from: "A1",
                            to: {
                                row: c.length + 1,
                                column: d.length - 1
                            }
                        }), A.xlsx.writeBuffer().then(function (e) {
                            var o = new Blob([e], {
                                type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                            })
                            saveAs(o, "Mohasib Friend-eInvoices.xlsx"), window.EtaProcessor.updateProgressBar(C.length, C.length,
                                "File Saved Successfully"), setTimeout(() => {
                                    window.EtaProcessor.finishDownload()
                                }, 1500)
                        })
            }
        } catch (e) {
            console.log(e), window.EtaProcessor.updateProgressBar(0, 0, "Error: " + e.message), setTimeout(() => {
                window.EtaProcessor.finishDownload()
            }, 1500)
        }
    },
    downloadExcelForReceipts: async function (e, o) {
        try {
            var t = e.length
            if (t > 0) {
                var r = $(".downloadAllBtn")
                $(r).addClass("disabled"), $("#cancelDownloadBtn").show(), window.EtaProcessor.isCancellationRequested = !1,
                    window.EtaProcessor.isDownloading = !0
                var i = []
                const f = 100
                let v = 0
                window.EtaProcessor.updateProgressBar(0, t, "Preparing Download Operation...")
                for (let o = 0; o < e.length && !window.EtaProcessor.isCancellationRequested; o += f) {
                    const r = e.slice(o, o + f)
                    for (const o of r) {
                        if (window.EtaProcessor.isCancellationRequested) break
                        const r = o.receipt || o
                        try {
                            const e = await window.EtaProcessor.getDocumentDetails(r.uuid, "receipts")
                            v++, window.EtaProcessor.updateProgressBar(v, t, `Downloading (${v}/${t})`), void 0 !== e && (r
                                .docDetail = e.receipt, i.push(r))
                        } catch (e) {
                            console.log(`Error fetching details for receipt ${r.uuid}:`, e), v++, window.EtaProcessor
                                .updateProgressBar(v, t, `Downloading (${v}/${t})`)
                        }
                        if (window.EtaProcessor.isCancellationRequested) {
                            window.EtaProcessor.updateProgressBar(v, t, "Saving Downloaded Records...")
                            break
                        }
                    }
                    if (window.EtaProcessor.isCancellationRequested) break
                }
                window.EtaProcessor.updateProgressBar(t, t, "Preparing Excel Sheet...")
                const P = new ExcelJS.Workbook,
                    k = P.addWorksheet("جميع الإيصالات")
                k.views = [{
                    rightToLeft: !0,
                    rtl: !0,
                    activeCell: "A1",
                    state: "frozen",
                    ySplit: 1
                }]
                const E = o?.columns || {}
                var a, s = [{
                    header: "مسلسل",
                    key: "index",
                    width: 10
                }, {
                    header: "تفاصيل",
                    key: "details",
                    width: 10,
                    style: {
                        font: {
                            name: "Comic Sans MS",
                            family: 4,
                            size: 12,
                            underline: !0,
                            bold: !0
                        }
                    }
                }, {
                    header: "نوع الإيصال",
                    key: "type",
                    width: 12
                }, {
                    header: "الحالة",
                    key: "status",
                    width: 10
                }, {
                    header: "تاريخ الإصدار",
                    key: "dateTimeIssued",
                    width: 13
                }, {
                    header: "تاريخ الإستلام",
                    key: "dateTimeReceived",
                    width: 13
                }, {
                    header: "عملة الإيصال",
                    key: "currency",
                    width: 13
                }, {
                    header: "قيمة الإيصال",
                    key: "netAmount",
                    width: 12
                }, {
                    header: "إجمالى الإيصال",
                    key: "totalAmount",
                    width: 14
                }, {
                    header: "رقم الإيصال",
                    key: "receiptNumber",
                    width: 23
                }, {
                    header: "الرقم الإلكترونى",
                    key: "uuid",
                    width: 32
                }, {
                    header: "سيريال نقطة البيع",
                    key: "deviceSerialNumber",
                    width: 17
                }, {
                    header: "إسم نقطة البيع",
                    key: "submitterName",
                    width: 17
                }, {
                    header: "الرقم الضريبى للبائع",
                    key: "issuerId",
                    width: 17
                }, {
                    header: "إسم البائع",
                    key: "issuerName",
                    width: 32
                }, {
                    header: "عنوان البائع",
                    key: "issuerAddress",
                    width: 32
                }, {
                    header: "الرقم الضريبى للمشترى",
                    key: "receiverId",
                    width: 17
                }, {
                    header: "إسم المشترى",
                    key: "receiverName",
                    width: 32
                }, {
                    header: "رقم المشترى",
                    key: "receiverMobileNumber",
                    width: 32
                }].filter(e => "index" === e.key || "details" === e.key || !1 !== E[e.key]),
                    n = [],
                    d = [],
                    c = [],
                    l = [],
                    u = 1,
                    p = 1,
                    w = [{
                        header: "كود الصنف",
                        key: "itemCode",
                        width: 14
                    }, {
                        header: "إسم الكود",
                        key: "itemCodeNameAr",
                        width: 14
                    }, {
                        header: "الوصف",
                        key: "description",
                        width: 25
                    }, {
                        header: "الكمية",
                        key: "quantity",
                        width: 10
                    }, {
                        header: "السعر",
                        key: "unitPrice",
                        width: 10
                    }, {
                        header: "القيمة",
                        key: "netSale",
                        width: 10
                    }, {
                        header: "الإجمالى",
                        key: "total",
                        width: 10,
                        totalsRowFunction: "sum"
                    }]
                o?.combineAll && (w = [{
                    header: "نوع الإيصال",
                    key: "type",
                    width: 12
                }, {
                    header: "رقم الإيصال",
                    key: "receiptNumber",
                    width: 23
                }, {
                    header: "تاريخ الإصدار",
                    key: "dateTimeIssued",
                    width: 13
                }, {
                    header: "تاريخ الإستلام",
                    key: "dateTimeReceived",
                    width: 13
                }, {
                    header: "كود الصنف",
                    key: "itemCode",
                    width: 14
                }, {
                    header: "إسم الكود",
                    key: "itemCodeNameAr",
                    width: 14
                }, {
                    header: "الوصف",
                    key: "description",
                    width: 25
                }, {
                    header: "الكمية",
                    key: "quantity",
                    width: 10
                }, {
                    header: "السعر",
                    key: "unitPrice",
                    width: 10
                }, {
                    header: "القيمة",
                    key: "netSale",
                    width: 10
                }, {
                    header: "الإجمالى",
                    key: "total",
                    width: 10
                }, {
                    header: "سيريال نقطة البيع",
                    key: "deviceSerialNumber",
                    width: 17
                }, {
                    header: "إسم نقطة البيع",
                    key: "submitterName",
                    width: 17
                }, {
                    header: "الرقم الضريبى للبائع",
                    key: "issuerId",
                    width: 17
                }, {
                    header: "إسم البائع",
                    key: "issuerName",
                    width: 32
                }, {
                    header: "عنوان البائع",
                    key: "issuerAddress",
                    width: 32
                }, {
                    header: "الرقم الضريبى للمشترى",
                    key: "receiverId",
                    width: 17
                }, {
                    header: "إسم المشترى",
                    key: "receiverName",
                    width: 32
                }, {
                    header: "رقم المشترى",
                    key: "receiverMobileNumber",
                    width: 32
                }], a = P.addWorksheet("بيانات الإيصالات")), d = w.filter(e => "index" === e.key || "details" === e.key ||
                    !1 !== E[e.key]), window.EtaProcessor.updateProgressBar(t, t, "Processing Receipt Details...")
                let x = 0
                for (const e of i) {
                    x++, window.EtaProcessor.updateProgressBar(x, i.length, `Processing ${x}/${i.length}`)
                    var h = e.docDetail
                    if (void 0 !== h) {
                        var m = h.currency,
                            g = h.seller.branchAddress ?? [],
                            y = (h.buyer.branchAddress, {
                                index: x,
                                type: h.documentType.receiptTypeNameAr,
                                status: h.status,
                                dateTimeIssued: window.EtaProcessor.toUserLocalTime(h.dateTimeIssued),
                                dateTimeReceived: window.EtaProcessor.toUserLocalTime(h.dateTimeReceived),
                                currency: m,
                                receiptNumber: h.receiptNumber,
                                netAmount: h.totalSales,
                                totalAmount: h.totalAmount,
                                uuid: h.uuid,
                                deviceSerialNumber: e.posSerialNumber,
                                submitterName: e.submitterName,
                                issuerId: h.seller.sellerId,
                                issuerName: h.seller.sellerName,
                                issuerAddress: `${g.buildingNumber} ${g.street} ${g.regionCity} ${g.governate}`,
                                receiverId: h.buyer.buyerId,
                                receiverName: h.buyer.buyerName,
                                receiverMobileNumber: h.buyer.mobileNumber
                            })
                        o?.taxColumns && $.each(h.taxTotals, (e, o) => {
                            if (-1 == window.EtaProcessor.getColumnIndex(s, o.taxType)) {
                                var t = window.EtaProcessor.getTaxTypeDescription(o.taxType)
                                s.splice(window.EtaProcessor.getColumnIndex(s, "totalAmount"), 0, {
                                    header: t.description,
                                    key: o.taxType,
                                    width: t.width
                                })
                            }
                            y[o.taxType] = o.amount
                        }), o?.discountColumns && (h.totalItemsDiscount && h.totalItemsDiscount > 0 && (-1 == window
                            .EtaProcessor.getColumnIndex(s, "itemsDiscount") && s.splice(window.EtaProcessor.getColumnIndex(s,
                                "totalAmount"), 0, {
                                header: "خصم الأصناف",
                                key: "itemsDiscount",
                                width: 13
                            }), y.itemsDiscount = h.totalItemsDiscount), h.totalCommercialDiscount && h
                                .totalCommercialDiscount > 0 && (-1 == window.EtaProcessor.getColumnIndex(s,
                                    "commercialDiscount") && s.splice(window.EtaProcessor.getColumnIndex(s, "totalAmount"), 0, {
                                        header: "خصم",
                                        key: "commercialDiscount",
                                        width: 13
                                    }), y.commercialDiscount = h.totalCommercialDiscount))
                        var b = x
                        o?.combineAll || (c = [], a = P.addWorksheet(`${b}`)), a.views = [{
                            rightToLeft: !0,
                            rtl: !0,
                            activeCell: "A1",
                            state: "frozen",
                            ySplit: 1
                        }], p = u + 1, l.push(p), $.each(h.itemData, (t, r) => {
                            u += 1
                            var i = {
                                type: h.documentType.receiptTypeNameAr,
                                receiptNumber: h.receiptNumber,
                                dateTimeIssued: window.EtaProcessor.toUserLocalTime(h.dateTimeIssued),
                                dateTimeReceived: window.EtaProcessor.toUserLocalTime(h.dateTimeReceived),
                                itemCode: r.itemCode,
                                itemCodeNameAr: r.itemCodeNameAr,
                                description: r.description,
                                quantity: r.quantity,
                                unitPrice: r.unitPrice,
                                netSale: r.netSale,
                                total: r.total,
                                deviceSerialNumber: e.posSerialNumber,
                                submitterName: e.submitterName,
                                issuerId: h.seller.sellerId,
                                issuerName: h.seller.sellerName,
                                issuerAddress: `${g.buildingNumber} ${g.street} ${g.regionCity} ${g.governate}`,
                                receiverId: h.buyer.buyerId,
                                receiverName: h.buyer.buyerName,
                                receiverMobileNumber: h.buyer.mobileNumber
                            }
                            o?.taxColumns && $.each(r.taxableItems, (e, o) => {
                                if (-1 == window.EtaProcessor.getColumnIndex(d, o.taxType)) {
                                    var t = window.EtaProcessor.getTaxTypeDescription(o.taxType)
                                    d.splice(window.EtaProcessor.getColumnIndex(d, "total"), 0, {
                                        header: t.description,
                                        key: o.taxType,
                                        width: t.width
                                    })
                                }
                                i[o.taxType] = o.amount
                            }), o?.discountColumns && r.valueDifference && r.valueDifference > 0 && (-1 == window
                                .EtaProcessor.getColumnIndex(d, "valueDifference") && d.splice(window.EtaProcessor
                                    .getColumnIndex(d, "total"), 0, {
                                    header: "فرق قيمة لأغراض الضريبة",
                                    key: "valueDifference",
                                    width: 20
                                }), i.valueDifference = r.valueDifference), c.push(i), t == h.itemData.length - 1 && (o
                                    ?.combineAll || (a.columns = d, a.addRows(c), a.addRow({
                                        itemCode: {
                                            text: "عودة",
                                            hyperlink: `#'جميع الإيصالات'!B${b + 1}`
                                        }
                                    }), a.getCell(`A${h.itemData.length + 2}`).font = {
                                        name: "Calibri",
                                        size: 14,
                                        underline: !0,
                                        bold: !0
                                    }))
                        }), y.details = o?.combineAll ? {
                            text: "عرض",
                            hyperlink: `#'بيانات الإيصالات'!A${p}`
                        } : {
                            text: "عرض",
                            hyperlink: `#'${b}'!A1`
                        }, n.push(y)
                    }
                }
                window.EtaProcessor.updateProgressBar(x, i.length, "Saving Excel File..."), k.columns = s, k.addRows(n), o
                    ?.combineAll && (a.columns = d, a.addRows(c), $.each(l, (e, o) => {
                        a.getCell(`A${o}`).font = {
                            name: "Calibri",
                            size: 11,
                            underline: !0,
                            bold: !0
                        }
                    })), k.getCell("B1").font = {
                        name: "Calibri",
                        size: 11,
                        underline: !1,
                        bold: !1
                    }, k.autoFilter = {
                        from: "A1",
                        to: {
                            row: n.length + 1,
                            column: s.length - 1
                        }
                    }, a && (a.autoFilter = {
                        from: "A1",
                        to: {
                            row: c.length + 1,
                            column: d.length - 1
                        }
                    }), P.xlsx.writeBuffer().then(function (e) {
                        var o = new Blob([e], {
                            type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                        })
                        saveAs(o, "Mohasib Friend-ereceipts.xlsx"), window.EtaProcessor.updateProgressBar(i.length, i.length,
                            "File Saved Successfully"), setTimeout(() => {
                                window.EtaProcessor.finishDownload()
                            }, 1500)
                    })
            }
        } catch (e) {
            console.log(e), window.EtaProcessor.updateProgressBar(0, 0, "Error: " + e.message), setTimeout(() => {
                window.EtaProcessor.finishDownload()
            }, 1500)
        }
    },
    downloadExcelForReceiptsNoDetails: async function (e, o) {
        try {
            var t = e.length
            if (t > 0) {
                var r = $(".downloadAllBtn")
                $(r).addClass("disabled"), $("#cancelDownloadBtn").show(), window.EtaProcessor.isCancellationRequested = !1,
                    window.EtaProcessor.isDownloading = !0, window.EtaProcessor.updateProgressBar(0, t,
                        "Preparing Excel Generation...")
                const c = new ExcelJS.Workbook,
                    l = c.addWorksheet("جميع الإيصالات")
                l.views = [{
                    rightToLeft: !0,
                    rtl: !0,
                    activeCell: "A1",
                    state: "frozen",
                    ySplit: 1
                }]
                const u = o?.columns || {}
                for (var i = [{
                    header: "مسلسل",
                    key: "index",
                    width: 10
                }, {
                    header: "نوع الإيصال",
                    key: "type",
                    width: 12
                }, {
                    header: "الحالة",
                    key: "status",
                    width: 10
                }, {
                    header: "تاريخ الإصدار",
                    key: "dateTimeIssued",
                    width: 13
                }, {
                    header: "تاريخ الإستلام",
                    key: "dateTimeReceived",
                    width: 13
                }, {
                    header: "عملة الإيصال",
                    key: "currency",
                    width: 13
                }, {
                    header: "قيمة الإيصال",
                    key: "netAmount",
                    width: 12
                }, {
                    header: "إجمالى الإيصال",
                    key: "totalAmount",
                    width: 14
                }, {
                    header: "رقم الإيصال",
                    key: "receiptNumber",
                    width: 23
                }, {
                    header: "الرقم الإلكترونى",
                    key: "uuid",
                    width: 32
                }, {
                    header: "سيريال نقطة البيع",
                    key: "deviceSerialNumber",
                    width: 17
                }, {
                    header: "إسم نقطة البيع",
                    key: "submitterName",
                    width: 17
                }, {
                    header: "الرقم الضريبى للبائع",
                    key: "issuerId",
                    width: 17
                }, {
                    header: "إسم البائع",
                    key: "issuerName",
                    width: 32
                }, {
                    header: "الرقم الضريبى للمشترى",
                    key: "receiverId",
                    width: 17
                }, {
                    header: "إسم المشترى",
                    key: "receiverName",
                    width: 32
                }].filter(e => "index" === e.key || !1 !== u[e.key]), a = [], s = 0; s < t && !window.EtaProcessor
                    .isCancellationRequested; s++) {
                    var n = e[s]
                    if (null != n) {
                        window.EtaProcessor.updateProgressBar(s + 1, t, `Processing ${s + 1}/${t}`)
                        var d = {
                            index: s + 1,
                            type: n.documentTypeNameSecondaryLang,
                            status: n.status,
                            dateTimeIssued: window.EtaProcessor.toUserLocalTime(n.dateTimeIssued),
                            dateTimeReceived: window.EtaProcessor.toUserLocalTime(n.dateTimeReceived),
                            currency: n.currency,
                            receiptNumber: n.receiptNumber,
                            netAmount: n.totalSales,
                            totalAmount: n.totalAmount,
                            uuid: n.uuid,
                            deviceSerialNumber: n.posSerialNumber,
                            submitterName: n.submitterName,
                            issuerId: n.issuerId,
                            issuerName: n.issuerName,
                            receiverId: n.receiverId,
                            receiverName: n.receiverName
                        }
                        o?.taxColumns && n.taxTotals && $.each(n.taxTotals, (e, o) => {
                            if (-1 == window.EtaProcessor.getColumnIndex(i, o.taxType)) {
                                var t = window.EtaProcessor.getTaxTypeDescription(o.taxType)
                                i.splice(window.EtaProcessor.getColumnIndex(i, "totalAmount"), 0, {
                                    header: t.description,
                                    key: o.taxType,
                                    width: t.width
                                })
                            }
                            d[o.taxType] = o.amount
                        }), o?.discountColumns && (n.totalItemsDiscount && n.totalItemsDiscount > 0 && (-1 == window
                            .EtaProcessor.getColumnIndex(i, "itemsDiscount") && i.splice(window.EtaProcessor.getColumnIndex(i,
                                "totalAmount"), 0, {
                                header: "خصم الأصناف",
                                key: "itemsDiscount",
                                width: 13
                            }), d.itemsDiscount = n.totalItemsDiscount), n.totalCommercialDiscount && n
                                .totalCommercialDiscount > 0 && (-1 == window.EtaProcessor.getColumnIndex(i,
                                    "commercialDiscount") && i.splice(window.EtaProcessor.getColumnIndex(i, "totalAmount"), 0, {
                                        header: "خصم",
                                        key: "commercialDiscount",
                                        width: 13
                                    }), d.commercialDiscount = n.totalCommercialDiscount)), a.push(d)
                    }
                    if (window.EtaProcessor.isCancellationRequested) {
                        window.EtaProcessor.updateProgressBar(s + 1, t, "Saving Downloaded Records...")
                        break
                    }
                }
                a.length > 0 ? (window.EtaProcessor.updateProgressBar(a.length, t, "Generating Excel..."), l.columns = i, l
                    .addRows(a), l.autoFilter = {
                        from: "A1",
                        to: {
                            row: a.length + 1,
                            column: i.length - 1
                        }
                    }, c.xlsx.writeBuffer().then(function (e) {
                        var o = new Blob([e], {
                            type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                        })
                        saveAs(o, "Mohasib Friend-ereceipts.xlsx")
                        const r = window.EtaProcessor.isCancellationRequested ?
                            `Export Cancelled - ${a.length} records saved` : "File Saved Successfully"
                        window.EtaProcessor.updateProgressBar(a.length, t, r), setTimeout(() => {
                            window.EtaProcessor.finishDownload()
                        }, 1500)
                    })) : (window.EtaProcessor.updateProgressBar(0, t, ""), setTimeout(() => {
                        window.EtaProcessor.finishDownload()
                    }, 1500))
            }
        } catch (e) {
            console.log(e), window.EtaProcessor.updateProgressBar(0, 0, "Error: " + e.message), setTimeout(() => {
                window.EtaProcessor.finishDownload()
            }, 1500)
        }
    },
    downloadJsonForReceipts: async function (e, o) {
        try {
            var t = e.length
            if (t > 0) {
                var r = new JSZip,
                    i = $(".downloadAllBtn")
                $(i).addClass("disabled"), $("#cancelDownloadBtn").show(), window.EtaProcessor.isCancellationRequested = !1,
                    window.EtaProcessor.isDownloading = !0
                var a = 0,
                    s = []
                window.EtaProcessor.updateProgressBar(0, t, "Preparing Download Process...")
                const u = o?.batchSize || 50
                for (let o = 0; o < e.length && !window.EtaProcessor.isCancellationRequested; o += u) {
                    const i = e.slice(o, Math.min(o + u, t))
                    for (const o of i) {
                        if (window.EtaProcessor.isCancellationRequested) break
                        const i = o.receipt || o
                        try {
                            window.EtaProcessor.updateProgressBar(a, t,
                                `Downloading File ${a + 1}/${t}: ${i.uuid.substring(0, 8)}...`)
                            const e = await window.EtaProcessor.DownloadFile(i.uuid, !1, "receipts")
                            var n = i.uuid.replaceAll(" ", "")
                            $.inArray(n, s) > -1 && (n = `${n}_${a}`), s.push(n)
                            var d = window.EtaProcessor.jsonToBlob(e),
                                c = "<document>" + window.EtaProcessor.OBJtoXML(e) + "</document>",
                                l = new Blob([c], {
                                    type: "application/xml"
                                })
                            r.file(n.concat(".json"), d), r.file(n.concat(".xml"), l), a++, window.EtaProcessor.updateProgressBar(
                                a, t, `Downloaded ${a}/${t} Files Successfully`)
                        } catch (e) {
                            console.log(`Error downloading file for ${i.uuid}:`, e), a++, window.EtaProcessor.updateProgressBar(a,
                                t, `Downloaded ${a}/${t} Files Successfully`)
                        }
                        if (window.EtaProcessor.isCancellationRequested) {
                            window.EtaProcessor.updateProgressBar(a, t, "Saving Downloaded Files...")
                            break
                        }
                    }
                    if (window.EtaProcessor.isCancellationRequested) break
                }
                if (a > 0) {
                    const e = window.EtaProcessor.isCancellationRequested ? "Finalizing Downloaded Files..." :
                        "Initializing ZIP File..."
                    window.EtaProcessor.updateProgressBar(a, t, e), r.generateAsync({
                        type: "blob"
                    }).then(function (e) {
                        const o = window.EtaProcessor.isCancellationRequested ? `Download Cancelled - ${a} files saved` :
                            "Operation Completed Successfully!"
                        window.EtaProcessor.updateProgressBar(a, t, o), setTimeout(() => {
                            window.EtaProcessor.finishDownload(), saveAs(e, "Mohasib Friend-ereceipts.zip")
                        }, 1500)
                    })
                } else window.EtaProcessor.updateProgressBar(a, t, ""), setTimeout(() => {
                    window.EtaProcessor.finishDownload()
                }, 1500)
            }
        } catch (e) {
            console.log(e), window.EtaProcessor.updateProgressBar(0, 0, "Error: " + e.message), setTimeout(() => {
                window.EtaProcessor.finishDownload()
            }, 1500)
        }
    },
    downloadAllPages: async function () {
        if (window.EtaProcessor.responseTotalCount > 0) {
            var e = Math.ceil(window.EtaProcessor.responseTotalCount / 100),
                o = new $.Deferred
            $(".downloadAllBtn").addClass("disabled"), window.EtaProcessor.isDownloading = !0
            var t, r = [],
                a = 0,
                s = window.EtaProcessor.replaceUrlParam(i, "PageSize", 100)
            window.EtaProcessor.updateProgressBar(0, e, "Calculating Pages...")
            try {
                for (var n = 1; n <= e && !window.EtaProcessor.isCancellationRequested; n++) window.EtaProcessor
                    .updateProgressBar(n - 1, e, `Downloading Page (${n}/${e})`), n % 50 == 0 || a >= 50 ? (a = 1, s = window
                        .EtaProcessor.replaceUrlParam(s, "SubmissionDateTo", t)) : a++, s = window.EtaProcessor.replaceUrlParam(
                            s, "PageNo", a), s = window.EtaProcessor.replaceUrlParam(s, "Page", a), await window.EtaProcessor
                                .getInvoiceList(s).then(i => {
                                    if (null == i) n = e, o.resolve(r)
                                    else if (t = i.result.length ? i.result[i.result.length - 1].source ? i.result[i.result.length - 1]
                                        .source.submissionDate : i.result[i.result.length - 1].dateTimeReceived : t, r = window.EtaProcessor
                                            .mergeArray(r, i.result || [], (e, o) => o.uuid ? e.uuid === o.uuid : e.source.uuid === o.source
                                                .uuid), window.EtaProcessor.updateProgressBar(n, e,
                                                    `Downloaded Page (${n}/${e}) - Found ${r.length} Records`), n == e)
                                        if (r.length <= window.EtaProcessor.responseTotalCount) {
                                            var a = e - Math.ceil(r.length / 100)
                                            0 == a && r.length == window.EtaProcessor.responseTotalCount ? o.resolve(r) : n = e - a - 1
                                        } else r.length > window.EtaProcessor.responseTotalCount && (r = r.slice(0, window.EtaProcessor
                                            .responseTotalCount)), o.resolve(r)
                                })
                window.EtaProcessor.isCancellationRequested ? (window.EtaProcessor.updateProgressBar(e, e,
                    "Operation Cancelled"), setTimeout(() => {
                        window.EtaProcessor.finishDownload()
                    }, 1500), o.resolve(r)) : window.EtaProcessor.updateProgressBar(e, e, `Downloaded ${r.length} Documents`)
            } catch (e) {
                console.log(e), window.EtaProcessor.updateProgressBar(0, 0, "Error: " + e.message), setTimeout(() => {
                    window.EtaProcessor.finishDownload()
                }, 1500), o.resolve(r)
            }
            return o.promise()
        }
    },
    downloadAllInvoices: async function (e, o, t) {
        try {
            var r = e.length
            if (r > 0) {
                var i = new JSZip
                $(".downloadAllBtn").addClass("disabled"), window.EtaProcessor.isCancellationRequested = !1, window
                    .EtaProcessor.isDownloading = !0
                var a = [],
                    s = 0
                window.EtaProcessor.updateProgressBar(0, r, "Preparing Download Process...")
                const l = t?.batchSize || 50
                for (let u = 0; u < e.length && !window.EtaProcessor.isCancellationRequested; u += l) {
                    const p = e.slice(u, Math.min(u + l, r))
                    for (const l of p) {
                        if (window.EtaProcessor.isCancellationRequested) break
                        const u = l.source || l
                        try {
                            window.EtaProcessor.updateProgressBar(s, r, `Downloading File ${s + 1}/${r}...`)
                            const e = await window.EtaProcessor.DownloadFile(u.uuid, o),
                                l = u.documentTypeNameAr || u.documentTypeNameSecondaryLang,
                                p = u.issueDate || u.dateTimeIssued,
                                w = u.submitterId || u.issuerId,
                                h = u.submitterName || u.issuerName,
                                m = u.recipientId || u.receiverId,
                                g = u.recipientName || u.receiverName,
                                y = u.internalId?.replaceAll("\\", "-").replaceAll("/", "-") || ""
                            let b = ""
                            const f = t || window.EtaProcessor.getEnhancedOptions()
                            if (f.date && (b = window.EtaProcessor.concatString(b, window.EtaProcessor.getFormattedLocalDate(p))),
                                f.id && (b = window.EtaProcessor.concatString(b, `(${y})`)), f.seller_id && f.seller_name ? b =
                                    window.EtaProcessor.concatString(b, `(${w} ${h})`) : (f.seller_id && (b = window.EtaProcessor
                                        .concatString(b, w)), f.seller_name && (b = window.EtaProcessor.concatString(b, h))), f
                                            .buyer_id && f.buyer_name ? b = window.EtaProcessor.concatString(b, `(${m} ${g})`) : (f.buyer_id &&
                                                (b = window.EtaProcessor.concatString(b, m)), f.buyer_name && (b = window.EtaProcessor
                                                    .concatString(b, g))), f.type && (b = window.EtaProcessor.concatString(b, `(${l})`)), f.uuid &&
                                (b = window.EtaProcessor.concatString(b, u.uuid)), f.purchaseOrderNumber || f.salesOrderNumber) {
                                const e = await window.EtaProcessor.getDocumentDetails(u.uuid)
                                f.purchaseOrderNumber && e.purchaseOrderReference && (b = window.EtaProcessor.concatString(b,
                                    `PO(${e.purchaseOrderReference})`)), f.salesOrderNumber && e.salesOrderReference && (b = window
                                        .EtaProcessor.concatString(b, `SO(${e.salesOrderReference})`))
                            }
                            if (void 0 === b && (b = window.EtaProcessor.pad(s + 1, 3)), b = b.replaceAll("\\", "-").replaceAll(
                                "/", "-"), f.separate_seller && (b = `${w} ${h}/${b}`), f.separate_buyer && (b =
                                    `${m} ${g}/${b}`), $.inArray(b, a) > -1 && (b = window.EtaProcessor.concatString(b, `(${u.uuid})`)),
                                a.push(b), o) i.file(b.concat(".pdf"), e, {
                                    binary: !0
                                })
                            else {
                                var n = window.EtaProcessor.jsonToBlob(e),
                                    d = "<document>" + window.EtaProcessor.OBJtoXML(e) + "</document>",
                                    c = new Blob([d], {
                                        type: "application/xml"
                                    })
                                i.file(b.concat(".json"), n), i.file(b.concat(".xml"), c)
                            }
                            s++, window.EtaProcessor.updateProgressBar(s, r, `Downloaded ${s}/${r} File Successfully`)
                        } catch (e) {
                            console.log(`Error downloading file for ${u.uuid}:`, e), s++, window.EtaProcessor.updateProgressBar(s,
                                r, `Downloaded ${s}/${r} File Successfully`)
                        }
                        if (window.EtaProcessor.isCancellationRequested) {
                            window.EtaProcessor.updateProgressBar(s, r, "Saving Downloaded Files...")
                            break
                        }
                    }
                    if (window.EtaProcessor.isCancellationRequested) break
                }
                s > 0 ? (window.EtaProcessor.updateProgressBar(s, r, "Initializing ZIP File..."), i.generateAsync({
                    type: "blob"
                }).then(function (e) {
                    const o = window.EtaProcessor.isCancellationRequested ? `Download Cancelled - ${s} files saved` :
                        "Operation Completed Successfully!"
                    window.EtaProcessor.updateProgressBar(s, r, o), setTimeout(() => {
                        window.EtaProcessor.finishDownload(), saveAs(e, "Mohasib Friend-eInvoices.zip")
                    }, 1500)
                })) : (window.EtaProcessor.updateProgressBar(s, r, "Cancelled"), setTimeout(() => {
                    window.EtaProcessor.finishDownload()
                }, 1500))
            }
        } catch (e) {
            console.log(e), window.EtaProcessor.updateProgressBar(0, 0, "Error: " + e.message), setTimeout(() => {
                window.EtaProcessor.finishDownload()
            }, 1500)
        }
    },
    downloadAllReceiptPages: async function (e) {
        var o = window.EtaProcessor.responseTotalCount || 0
        if (o > 0) {
            var t = new $.Deferred
            $(".downloadAllBtn").addClass("disabled"), window.EtaProcessor.isDownloading = !0
            var r, a = [],
                s = e ? "dateTimeReceived" : "dateTimeIssued",
                n = e ? "DateTimeReceivedTo" : "DateTimeIssuedTo",
                d = window.EtaProcessor.replaceUrlParam(i, "PageSize", 100)
            d = window.EtaProcessor.replaceUrlParam(d, "SortBy", e ? "DateTimeReceived" : "DateTimeIssued"), d = window
                .EtaProcessor.replaceUrlParam(d, "SortDir", "Desc"), window.EtaProcessor.updateProgressBar(0, o,
                    "Starting receipt download...")
            try {
                let l = 1,
                    u = !0,
                    p = d
                for (; u && !window.EtaProcessor.isCancellationRequested;) {
                    let w = await c(p, r, e, a.length, o)
                    if (0 === w.length) u = !1
                    else {
                        r = w[w.length - 1][s], p = window.EtaProcessor.replaceUrlParam(d, n, r)
                        let h = a.length,
                            m = (a = window.EtaProcessor.mergeArray(a, w, (e, o) => e.uuid === o.uuid)).length - h
                        if (window.EtaProcessor.updateProgressBar(a.length, o,
                            `Processing Batch ${l}: ${m} new records (${a.length} total)`), window.EtaProcessor
                                .isCancellationRequested) {
                            window.EtaProcessor.updateProgressBar(a.length, o, "Saving Downloaded Records...")
                            break
                        } (h === a.length || a.length >= o || l > 20) && (u = !1), l++
                    }
                }
                if (window.EtaProcessor.isCancellationRequested) {
                    const g = a.length > 0 ? `Download Cancelled - ${a.length} records saved` : "Download Cancelled"
                    window.EtaProcessor.updateProgressBar(a.length, o, g)
                } else window.EtaProcessor.updateProgressBar(a.length, o, `Download Complete (${a.length}/${o})`)
                t.resolve(a)
            } catch (y) {
                console.log(y)
                const b = a.length > 0 ? `Error occurred - ${a.length} records saved` : "Error: " + y.message
                window.EtaProcessor.updateProgressBar(a.length, o, b), t.resolve(a)
            }
            return t.promise()
            async function c(e, o, t, r, i) {
                let a = [],
                    s = e,
                    n = t ? "DateTimeReceivedTo" : "DateTimeIssuedTo"
                o && (s = window.EtaProcessor.replaceUrlParam(s, n, o))
                for (let e = 1; e <= 30 && !window.EtaProcessor.isCancellationRequested; e++) {
                    let t = window.EtaProcessor.replaceUrlParam(s, "PageNo", e)
                    t = window.EtaProcessor.replaceUrlParam(t, "Page", e)
                    var d = r + a.length
                    window.EtaProcessor.updateProgressBar(d, i,
                        `Loading Batch ${e}: Added ${a.length} new records, Total Downloaded: ${d}, please wait...`)
                    try {
                        const e = await window.EtaProcessor.getInvoiceList(t)
                        if (!e) break
                        const o = e.receipts || e.result
                        if (!o || 0 === o.length) break
                        if (a = a.concat(o), window.EtaProcessor.isCancellationRequested) break
                        if (o.length < 100) break
                    } catch (o) {
                        console.log(`Error fetching page ${e}:`, o)
                        continue
                    }
                }
                return a
            }
        }
    },
    getInvoiceList: async function (e, o = 0) {
        try {
            return await new Promise((o, t) => {
                $.ajax({
                    url: e,
                    method: "GET",
                    cache: !1,
                    timeout: 5e3,
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: "Bearer ".concat(JSON.parse(localStorage.USER_DATA).access_token),
                        "Accept-Language": localStorage.i18nextLng || "ar"
                    },
                    xhr: function () {
                        var e = new XMLHttpRequest
                        return e.onreadystatechange = function () {
                            2 == e.readyState && 200 == e.status && (e.responseType = "text")
                        }, e
                    },
                    success: function (e) {
                        o(e)
                    },
                    error: function (e, o, r) {
                        t({
                            message: `Request failed: ${o}, ${r}`,
                            isTimeout: "timeout" === o,
                            status: e.status
                        })
                    }
                })
            })
        } catch (t) {
            return ++o <= (t.isTimeout ? 20 : 3) ? (await new Promise(e => setTimeout(e, 1e3)), await window.EtaProcessor
                .getInvoiceList(e, o)) : null
        }
    },
    downloadAllCodes: async function () {
        if (window.EtaProcessor.responseTotalCount > 0) {
            const s = Math.ceil(window.EtaProcessor.responseTotalCount / 100)
            var e = new $.Deferred,
                o = $(".downloadAllBtn")
            $(o).addClass("disabled"), window.EtaProcessor.isDownloading = !0
            var t = []
            $(".downloadAllBtnText").html(`Loading Page(1/${s})`)
            for (var r = 1; r <= s; r++) {
                var a = window.EtaProcessor.replaceUrlParam(i, "Ps", 100)
                a = window.EtaProcessor.replaceUrlParam(a, "Pn", r), await window.EtaProcessor.getInvoiceList(a).then(o => {
                    t = $.merge($.merge([], t), o.result), $(".downloadAllBtnText").html(`Loading Page(${r}/${s})`), r ==
                        s && e.resolve(t)
                })
            }
            return e.promise()
        }
    },
    DownloadFile: async function (e, o, t = "documents", r = 0) {
        var i = o ? "pdf" : "raw"
        try {
            var a, s = `https://api-portal.invoicing.eta.gov.eg/api/v1/${t}/${e}/${i}`
            return await $.ajax({
                url: s,
                method: "GET",
                cache: !1,
                timeout: 5e3,
                headers: {
                    "Content-Type": "application/json",
                    Authorization: "Bearer ".concat(JSON.parse(localStorage.USER_DATA).access_token),
                    "Accept-Language": localStorage.i18nextLng || "ar"
                },
                xhr: function () {
                    var e = new XMLHttpRequest
                    return e.onreadystatechange = function () {
                        2 == e.readyState && (200 == e.status ? e.responseType = o ? "blob" : "text" : e.responseType =
                            "text")
                    }, e
                },
                success: function (e) {
                    return a = o ? new Blob([e], {
                        type: "application/pdf"
                    }) : e
                }
            }), a
        } catch (i) {
            return ++r < (i.isTimeout ? 10 : 3) ? (await new Promise(e => setTimeout(e, 1e3)), await window.EtaProcessor
                .DownloadFile(e, o, t, r)) : void 0
        }
    },
    getDocumentDetails: async function (e, o = "documents", t = 0) {
        try {
            var r = `https://api-portal.invoicing.eta.gov.eg/api/v1/${o}/${e}/details?documentLinesLimit=1000`
            return await new Promise((e, o) => {
                $.ajax({
                    url: r,
                    method: "GET",
                    cache: !1,
                    timeout: 5e3,
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: "Bearer ".concat(JSON.parse(localStorage.USER_DATA).access_token),
                        "Accept-Language": localStorage.i18nextLng || "ar"
                    },
                    xhr: function () {
                        var e = new XMLHttpRequest
                        return e.onreadystatechange = function () {
                            2 == e.readyState && 200 == e.status && (e.responseType = "text")
                        }, e
                    },
                    success: function (o) {
                        e(o)
                    },
                    error: function (e, t, r) {
                        o({
                            message: `Request failed: ${t}, ${r}`,
                            isTimeout: "timeout" === t
                        })
                    }
                })
            })
        } catch (r) {
            return ++t < (r.isTimeout ? 10 : 3) ? (await new Promise(e => setTimeout(e, 1e3)), await window.EtaProcessor
                .getDocumentDetails(e, o, t)) : void 0
        }
    },
    getFormattedLocalDate: function (e) {
        if (!e) return null
        const o = new Date(e)
        var t = window.EtaProcessor.pad(o.getDate(), 2),
            r = window.EtaProcessor.pad(o.getMonth() + 1, 2)
        return `${o.getFullYear()}-${r}-${t}`
    },
    getFormattedDate: function (e) {
        var o = window.EtaProcessor.pad(e.getDate(), 2),
            t = window.EtaProcessor.pad(e.getMonth() + 1, 2)
        return `${e.getFullYear()}-${t}-${o}`
    },
    toUserLocalTime: function (e) {
        if (!e) return null
        const o = new Date(e),
            t = o.getUTCFullYear(),
            r = new Date(t, 3, 30),
            i = new Date(r)
        i.setDate(30 - (r.getDay() + 2) % 7)
        const a = new Date(t, 9, 31),
            s = new Date(a)
        s.setDate(31 - (a.getDay() + 3) % 7)
        const n = o >= i && o < s ? 3 : 2
        return new Date(o.getTime() + 60 * n * 60 * 1e3)
    },
    concatString: function (e, o) {
        return e ? e + " - " + o : o
    },
    pad: function (e, o) {
        return (e = e.toString()).length < o ? window.EtaProcessor.pad("0" + e, o) : e
    },
    getColumnIndex: function (e, o) {
        return e.indexOf(e.filter(function (e) {
            return e.key == o
        })[0])
    },
    getTaxTypeDescription: function (e) {
        return [{
            code: "T1",
            description: "ضريبة القيمة المضافة",
            width: 18
        }, {
            code: "T2",
            description: "ضريبة الجدول النسبية",
            width: 18
        }, {
            code: "T3",
            description: "ضريبة الجدول النوعية",
            width: 18
        }, {
            code: "T4",
            description: "الخصم تحت حساب الضريبة",
            width: 22
        }, {
            code: "T5",
            description: "ضريبة الدمغة النسبية",
            width: 22
        }, {
            code: "T13",
            description: "ضريبة الدمغة النسبية",
            width: 22
        }, {
            code: "T6",
            description: "ضريبة الدمغة قطعية بمقدار ثابت",
            width: 30
        }, {
            code: "T14",
            description: "ضريبة الدمغة قطعية بمقدار ثابت",
            width: 30
        }, {
            code: "T7",
            description: "ضريبة الملاهى",
            width: 14
        }, {
            code: "T15",
            description: "ضريبة الملاهى",
            width: 14
        }, {
            code: "T8",
            description: "رسم تنمية الموارد",
            width: 18
        }, {
            code: "T16",
            description: "رسم تنمية الموارد",
            width: 18
        }, {
            code: "T9",
            description: "رسم خدمة",
            width: 12
        }, {
            code: "T17",
            description: "رسم خدمة",
            width: 12
        }, {
            code: "T10",
            description: "رسم المحليات",
            width: 14
        }, {
            code: "T18",
            description: "رسم المحليات",
            width: 14
        }, {
            code: "T11",
            description: "رسم التامين الصحى",
            width: 18
        }, {
            code: "T19",
            description: "رسم التامين الصحى",
            width: 18
        }, {
            code: "T12",
            description: "رسوم أخرى",
            width: 12
        }, {
            code: "T20",
            description: "رسوم أخرى",
            width: 12
        }].find(o => o.code === e) || {
            code: e,
            description: "ضريبة غير معروفة",
            width: 15
        }
    },
    replaceUrlParam: function (e, o, t) {
        null == t && (t = "")
        var r = new RegExp("\\b(" + o + "=).*?(&|#|$)")
        return e.search(r) >= 0 ? e.replace(r, "$1" + t + "$2") : (e = e.replace(/[?#]$/, "")) + (e.indexOf("?") > 0 ?
            "&" : "?") + o + "=" + t
    },
    jsonToBlob: function (e) {
        const o = new TextEncoder,
            t = new WeakSet
        return function e(r) {
            if (t.has(r)) throw new TypeError("Converting circular structure to JSON")
            if (r && "function" == typeof r.toJSON && (r = r.toJSON()), "object" == typeof r && null !== r) {
                t.add(r)
                const i = [],
                    a = Array.isArray(r) ? r : Object.entries(r)
                for (let t = 0; t < a.length; t++) {
                    if (Array.isArray(r)) i.push(e(a[t]))
                    else {
                        const [r, s] = a[t]
                        i.push(o.encode(JSON.stringify(r) + ":"), e(s))
                    }
                    t !== a.length - 1 && i.push(o.encode(","))
                }
                const s = Array.isArray(r) ? "[" : "{",
                    n = Array.isArray(r) ? "]" : "}"
                return new Blob([o.encode(s), ...i, o.encode(n)])
            }
            return "function" == typeof r || void 0 === r ? o.encode("null") : o.encode(JSON.stringify(r))
        }(e)
    },
    OBJtoXML: function (e) {
        var o = ""
        for (var t in e) {
            if (o += e[t] instanceof Array ? "" : "<" + t + ">", e[t] instanceof Array)
                for (var r in e[t]) o += "<" + t + ">", o += window.EtaProcessor.OBJtoXML(new Object(e[t][r])), o += "</" +
                    t + ">"
            else "object" == typeof e[t] && "document" !== t ? o += window.EtaProcessor.OBJtoXML(new Object(e[t])) : o +=
                e[t]
            o += e[t] instanceof Array ? "" : "</" + t + ">"
        }
        return o.replace(/<\/?[0-9]{1,}>/g, "")
    },
    mergeArray: (e, o, t = (e, o) => e === o) => {
        const r = [...e]
        return o.forEach(e => r.some(o => t(e, o)) ? null : r.push(e)), r
    }
}